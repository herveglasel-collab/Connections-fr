<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Connections FR — multi-items + mesures</title>
  <style>
    :root{
      --bg:#f6f6f6;
      --card:#ffffff;
      --ink:#111;
      --muted:#666;
      --border:#d8d8d8;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 16px;
      --tileRadius: 14px;

      --accent:#0b57d0;
      --good:#1b7f3a;
      --bad:#b3261e;
      --warn:#b26a00;

      --sel:#111;
      --selText:#fff;

      --lockedBg:#eaf3ff;
      --lockedBorder:#b8d5ff;

      --focus:#000;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0f0f10;
        --card:#161617;
        --ink:#f2f2f2;
        --muted:#b5b5b5;
        --border:#2b2b2d;
        --shadow: 0 10px 30px rgba(0,0,0,.35);

        --sel:#f2f2f2;
        --selText:#111;

        --lockedBg:#0f2035;
        --lockedBorder:#254a7a;

        --focus:#fff;
      }
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 28px;
    }
    header{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom: 14px;
    }
    h1{
      margin:0;
      font-size: 22px;
      line-height:1.2;
    }
    .sub{
      margin-top:6px;
      color:var(--muted);
      font-size: 13px;
    }

    .panel{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .topgrid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
    }
    @media (max-width: 860px){
      .topgrid{ grid-template-columns: 1fr; }
    }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:end;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 160px;
    }
    label{
      font-size: 12px;
      color: var(--muted);
    }
    input, select{
      border:1px solid var(--border);
      background:transparent;
      color:var(--ink);
      border-radius: 12px;
      padding: 10px 10px;
      font-size: 14px;
      outline:none;
    }
    input:focus, select:focus{
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 35%, transparent);
      border-color: color-mix(in srgb, var(--accent) 60%, var(--border));
    }

    .btnrow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    button{
      border:1px solid var(--border);
      background:transparent;
      color:var(--ink);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 600;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }
    button.primary{
      background: var(--accent);
      color: #fff;
      border-color: color-mix(in srgb, var(--accent) 70%, var(--border));
    }
    button:disabled{
      opacity:.5;
      cursor:not-allowed;
    }

    .status{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
    }
    .pill{
      border:1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      background: color-mix(in srgb, var(--card) 75%, var(--bg));
    }
    .msg{
      font-weight:700;
      color: var(--ink);
    }
    .msg.good{ color: var(--good); }
    .msg.bad{ color: var(--bad); }
    .msg.warn{ color: var(--warn); }

    .game{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 860px){
      .game{ grid-template-columns: 1fr; }
    }

    .board{
      padding: 14px;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(110px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 520px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
    }
    .tile{
      border:1px solid var(--border);
      background: transparent;
      border-radius: var(--tileRadius);
      padding: 14px 10px;
      font-weight: 800;
      letter-spacing: .3px;
      text-transform: uppercase;
      text-align:center;
      line-height:1.1;
      min-height: 54px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      transition: transform .05s ease, background .12s ease, border-color .12s ease;
    }
    .tile:active{ transform: scale(.99); }
    .tile.selected{
      background: var(--sel);
      color: var(--selText);
      border-color: color-mix(in srgb, var(--sel) 40%, var(--border));
    }
    .tile.locked{
      background: var(--lockedBg);
      border-color: var(--lockedBorder);
      cursor:default;
      opacity: .98;
    }
    .tile.locked.selected{ /* sécurité */
      background: var(--lockedBg);
      color: var(--ink);
    }
    .tile:focus{
      outline:none;
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--focus) 20%, transparent);
    }

    .side{
      padding: 14px;
    }
    .sectionTitle{
      margin: 0 0 10px 0;
      font-size: 14px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .12em;
    }
    .foundList{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .catCard{
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 10px 10px;
      background: color-mix(in srgb, var(--card) 86%, var(--bg));
    }
    .catName{
      font-weight: 900;
      margin-bottom: 6px;
    }
    .catWords{
      color: var(--muted);
      font-size: 13px;
    }

    .metrics{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    @media (max-width: 520px){
      .metrics{ grid-template-columns: 1fr; }
    }
    .metric{
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 10px 10px;
      background: color-mix(in srgb, var(--card) 86%, var(--bg));
    }
    .metric .k{
      font-size: 12px;
      color: var(--muted);
    }
    .metric .v{
      margin-top: 4px;
      font-weight: 900;
      font-size: 16px;
    }

    details{
      margin-top: 14px;
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 10px 10px;
      background: color-mix(in srgb, var(--card) 86%, var(--bg));
    }
    summary{
      cursor:pointer;
      font-weight: 800;
    }
    .log{
      margin-top: 10px;
      max-height: 210px;
      overflow:auto;
      font-size: 12px;
      color: var(--muted);
      white-space: pre-wrap;
    }
    .tiny{
      font-size:12px;
      color:var(--muted);
      margin-top: 8px;
      line-height: 1.35;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      border:1px solid var(--border);
      border-bottom-width: 2px;
      padding: 1px 6px;
      border-radius: 8px;
      background: color-mix(in srgb, var(--card) 90%, var(--bg));
      color: var(--ink);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Connections — version française (multi-items + mesures)</h1>
        <div class="sub">Sélectionnez 4 mots qui vont ensemble, puis validez. Trouvez les 4 catégories.</div>
      </div>
    </header>

    <div class="panel topgrid">
      <div>
        <div class="controls">
          <div class="field">
            <label for="subjectId">ID du sujet (obligatoire en mode test)</label>
            <input id="subjectId" placeholder="ex : HGL-001" />
          </div>
          <div class="field">
            <label for="age">Âge (optionnel)</label>
            <input id="age" placeholder="ex : 7" inputmode="numeric" />
          </div>
          <div class="field">
            <label for="mode">Mode</label>
            <select id="mode">
              <option value="train">Entraînement (feedback + correction)</option>
              <option value="test">Test (feedback minimal)</option>
            </select>
          </div>
          <div class="field">
            <label for="level">Niveau</label>
            <select id="level">
              <option value="6-7">6–7 ans</option>
              <option value="8-9">8–9 ans</option>
              <option value="10-11">10–11 ans</option>
              <option value="12-13">12–13 ans</option>
              <option value="14-16">14–16 ans</option>
            </select>
          </div>
        </div>

        <div class="btnrow" style="margin-top:12px">
          <button class="primary" id="startBtn">Démarrer</button>
          <button id="newBtn" disabled>Nouvelle série</button>
          <button id="resetBtn" disabled>Réinitialiser la série</button>
          <button id="exportBtn">Exporter CSV</button>
        </div>

        <div class="status">
          <span class="pill"><span class="msg" id="msg">Prêt.</span></span>
          <span class="pill">Série : <strong id="seriesIdx">—</strong></span>
          <span class="pill">Trouvées : <strong id="foundCount">0</strong>/4</span>
          <span class="pill">Erreurs : <strong id="errCount">0</strong></span>
        </div>

        <div class="tiny">
          Astuce : sur ordinateur, <span class="kbd">Entrée</span> valide quand 4 mots sont sélectionnés.
        </div>
      </div>

      <div class="panel" style="padding:14px;">
        <div class="sectionTitle">Mesures (série en cours)</div>
        <div class="metrics">
          <div class="metric">
            <div class="k">Délai d’initiation</div>
            <div class="v" id="mInitiation">—</div>
          </div>
          <div class="metric">
            <div class="k">Temps total</div>
            <div class="v" id="mTotal">—</div>
          </div>
          <div class="metric">
            <div class="k">Nombre de clics</div>
            <div class="v" id="mClicks">0</div>
          </div>
          <div class="metric">
            <div class="k">Validations</div>
            <div class="v" id="mSubmits">0</div>
          </div>
        </div>

        <details>
          <summary>Journal des essais (local)</summary>
          <div class="log" id="log"></div>
        </details>
      </div>
    </div>

    <div class="game">
      <div class="panel board">
        <div class="sectionTitle">Grille 4×4</div>
        <div class="grid" id="grid"></div>

        <div class="btnrow" style="margin-top:12px">
          <button class="primary" id="validateBtn" disabled>Valider (4)</button>
          <button id="clearSelBtn" disabled>Effacer sélection</button>
          <button id="revealBtn" disabled>Afficher correction</button>
        </div>
      </div>

      <div class="panel side">
        <div class="sectionTitle">Catégories trouvées</div>
        <div class="foundList" id="foundList"></div>

        <div class="sectionTitle" style="margin-top:16px">Catégories (si correction)</div>
        <div class="tiny" id="answerHint">—</div>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  BANQUE D'ITEMS (exemples)
 *  =========================
 * Chaque item = 4 catégories * 4 mots = 16 mots.
 * Pour "générer à chaque essai", on pioche aléatoirement dans une banque
 * et on mélange l'ordre des 16 tuiles.
 *
 * IMPORTANT : pour le 6–7 ans, on garde des catégories simples et des mots fréquents.
 */
const ITEM_BANK = {
  "6-7": [
    {
      id: "6-7-A",
      groups: [
        { name: "ANIMAUX", words: ["CHAT", "CHIEN", "LAPIN", "POISSON"] },
        { name: "COULEURS", words: ["ROUGE", "BLEU", "VERT", "JAUNE"] },
        { name: "FRUITS",   words: ["POMME", "POIRE", "BANANE", "ORANGE"] },
        { name: "VÊTEMENTS",words: ["PULL", "PANTALON", "CHAUSSETTE", "CHAUSSURE"] }
      ]
    },
    {
      id: "6-7-B",
      groups: [
        { name: "ÉCOLE",   words: ["CRAYON", "GOMME", "CAHIER", "RÈGLE"] },
        { name: "MAISON",  words: ["PORTE", "FENÊTRE", "TABLE", "CHAISE"] },
        { name: "PARTIES DU CORPS", words: ["MAIN", "PIED", "TÊTE", "DOS"] },
        { name: "TRANSPORT", words: ["BUS", "TRAIN", "AVION", "BATEAU"] }
      ]
    },
    {
      id: "6-7-C",
      groups: [
        { name: "FERME", words: ["VACHE", "MOUTON", "POULE", "CHEVAL"] },
        { name: "JOUETS", words: ["POUPÉE", "BALLON", "PUZZLE", "TROTTINETTE"] },
        { name: "BOISSONS", words: ["EAU", "LAIT", "JUS", "CHOCOLAT"] },
        { name: "FORMES", words: ["ROND", "CARRÉ", "TRIANGLE", "ÉTOILE"] }
      ]
    },
  ],

  "8-9": [
    {
      id: "8-9-A",
      groups: [
        { name:"INSTRUMENTS", words:["PIANO","TAMBOUR","FLÛTE","GUITARE"] },
        { name:"MÉTÉO", words:["PLUIE","NEIGE","VENT","SOLEIL"] },
        { name:"SPORTS", words:["FOOT","TENNIS","NATATION","JUDO"] },
        { name:"CONTAINERS", words:["BOL","VERRE","ASSIETTE","BOUTEILLE"] }
      ]
    }
  ],

  "10-11": [
    {
      id:"10-11-A",
      groups: [
        { name:"SYNONYMES DE RAPIDE", words:["VIF","AGILE","PROMPT","EXPRESS"] },
        { name:"VENTS", words:["MISTRAL","SIROCCO","ALIZÉ","TRAMONTANE"] },
        { name:"TRANSPORTS", words:["BUS","TRAIN","AVION","BATEAU"] },
        { name:"PARTIES DU CORPS", words:["TÊTE","MAIN","PIED","DOS"] }
      ]
    }
  ],

  "12-13": [],
  "14-16": []
};

/** =========================
 *  ÉTAT & MESURES
 *  ========================= */
const state = {
  running:false,
  mode:"train",
  level:"6-7",
  currentItem:null,
  seriesNumber:0,

  // tuiles
  tiles:[],       // {word, groupIdx, locked:boolean}
  selected:new Set(), // indices
  foundGroups:[], // indices groupes trouvés

  // mesures
  t0:null,
  firstActionAt:null,
  clicks:0,
  submits:0,
  errors:0,

  // logs (multi séries)
  sessionLogs: [] // objets
};

const $ = (id)=>document.getElementById(id);

const ui = {
  grid:$("grid"),
  msg:$("msg"),
  foundList:$("foundList"),
  foundCount:$("foundCount"),
  errCount:$("errCount"),
  seriesIdx:$("seriesIdx"),
  answerHint:$("answerHint"),

  // metrics
  mInitiation:$("mInitiation"),
  mTotal:$("mTotal"),
  mClicks:$("mClicks"),
  mSubmits:$("mSubmits"),

  // inputs
  subjectId:$("subjectId"),
  age:$("age"),
  mode:$("mode"),
  level:$("level"),

  // buttons
  startBtn:$("startBtn"),
  newBtn:$("newBtn"),
  resetBtn:$("resetBtn"),
  validateBtn:$("validateBtn"),
  clearSelBtn:$("clearSelBtn"),
  revealBtn:$("revealBtn"),
  exportBtn:$("exportBtn"),

  log:$("log"),
};

function nowMs(){ return Date.now(); }
function fmtMs(ms){
  if(ms==null) return "—";
  const s = Math.max(0, Math.round(ms/100)/10); // 0.1s
  return `${s.toFixed(1)} s`;
}
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function setMsg(text, kind=""){
  ui.msg.textContent = text;
  ui.msg.className = "msg " + (kind||"");
}
function updateButtons(){
  const selCount = state.selected.size;
  ui.validateBtn.disabled = !state.running || selCount !== 4;
  ui.clearSelBtn.disabled = !state.running || selCount === 0;
  ui.resetBtn.disabled = !state.running;
  ui.newBtn.disabled = !state.running;
  ui.revealBtn.disabled = !state.running || state.mode !== "train";
}
function updateMetrics(){
  ui.mClicks.textContent = String(state.clicks);
  ui.mSubmits.textContent = String(state.submits);
  ui.errCount.textContent = String(state.errors);

  const initiation = (state.firstActionAt && state.t0) ? (state.firstActionAt - state.t0) : null;
  ui.mInitiation.textContent = fmtMs(initiation);

  const total = (state.t0) ? (nowMs() - state.t0) : null;
  ui.mTotal.textContent = state.running ? fmtMs(total) : "—";
}
function tick(){
  if(state.running){
    updateMetrics();
    requestAnimationFrame(tick);
  }
}

/** =========================
 *  CHARGEMENT D'UN ITEM
 *  ========================= */
function pickItem(level){
  const bank = ITEM_BANK[level] || [];
  if(bank.length === 0) return null;
  // on évite de répéter tout de suite si possible
  const shuffled = shuffle(bank);
  return shuffled[0];
}

function buildTilesFromItem(item){
  const tiles = [];
  item.groups.forEach((g, gi)=>{
    g.words.forEach(w=>{
      tiles.push({ word:w, groupIdx:gi, locked:false });
    });
  });
  return shuffle(tiles);
}

function resetSeriesMeasures(){
  state.t0 = nowMs();
  state.firstActionAt = null;
  state.clicks = 0;
  state.submits = 0;
  state.errors = 0;
  state.selected = new Set();
  state.foundGroups = [];
  ui.foundList.innerHTML = "";
  ui.foundCount.textContent = "0";
  ui.answerHint.textContent = "—";
  setMsg("Sélectionnez 4 mots puis validez.", "");
}

function startSeries(){
  const level = ui.level.value;
  const mode = ui.mode.value;

  state.mode = mode;
  state.level = level;

  const item = pickItem(level);
  if(!item){
    setMsg("Aucun item disponible pour ce niveau (banque vide).", "warn");
    return;
  }

  state.currentItem = item;
  state.seriesNumber += 1;
  state.running = true;

  state.tiles = buildTilesFromItem(item);
  resetSeriesMeasures();

  ui.seriesIdx.textContent = `${state.seriesNumber} (${item.id})`;
  render();
  updateButtons();
  updateMetrics();
  tick();
}

function resetSeriesOnly(){
  if(!state.currentItem) return;
  state.tiles = buildTilesFromItem(state.currentItem);
  resetSeriesMeasures();
  render();
  updateButtons();
}

/** =========================
 *  RENDU
 *  ========================= */
function render(){
  ui.grid.innerHTML = "";
  state.tiles.forEach((t, idx)=>{
    const btn = document.createElement("button");
    btn.className = "tile";
    btn.type = "button";
    btn.textContent = t.word;

    const selected = state.selected.has(idx);
    if(selected) btn.classList.add("selected");
    if(t.locked) btn.classList.add("locked");

    btn.disabled = !state.running || t.locked;
    btn.addEventListener("click", ()=>onTileClick(idx));
    ui.grid.appendChild(btn);
  });

  ui.foundCount.textContent = String(state.foundGroups.length);
}

function onTileClick(idx){
  if(!state.running) return;
  const tile = state.tiles[idx];
  if(tile.locked) return;

  state.clicks += 1;
  if(!state.firstActionAt) state.firstActionAt = nowMs();

  if(state.selected.has(idx)){
    state.selected.delete(idx);
  }else{
    if(state.selected.size >= 4){
      // si on clique un 5e, on ignore (ou on pourrait remplacer le plus ancien)
      setMsg("Déjà 4 mots sélectionnés. Validez ou effacez.", "warn");
      updateButtons();
      return;
    }
    state.selected.add(idx);
  }
  setMsg("…", "");
  render();
  updateButtons();
}

/** =========================
 *  VALIDATION
 *  ========================= */
function selectedWords(){
  return [...state.selected].map(i=>state.tiles[i].word);
}
function selectedGroupIdx(){
  const idxs = [...state.selected];
  const g = state.tiles[idxs[0]].groupIdx;
  return idxs.every(i=>state.tiles[i].groupIdx === g) ? g : null;
}
function lockGroup(groupIdx){
  state.tiles.forEach(t=>{
    if(t.groupIdx === groupIdx) t.locked = true;
  });
}
function addFoundCard(groupIdx){
  const g = state.currentItem.groups[groupIdx];
  const div = document.createElement("div");
  div.className = "catCard";
  div.innerHTML = `
    <div class="catName">✓ ${g.name}</div>
    <div class="catWords">${g.words.join(" · ")}</div>
  `;
  ui.foundList.appendChild(div);
}
function finishSeries(){
  const tEnd = nowMs();
  const total = tEnd - state.t0;
  const initiation = state.firstActionAt ? (state.firstActionAt - state.t0) : null;

  // log
  const subj = ui.subjectId.value.trim();
  const age = ui.age.value.trim();
  const logEntry = {
    timestampISO: new Date().toISOString(),
    subjectId: subj || "",
    age: age || "",
    mode: state.mode,
    level: state.level,
    itemId: state.currentItem?.id || "",
    seriesNumber: state.seriesNumber,
    initiationMs: initiation ?? "",
    totalMs: total,
    clicks: state.clicks,
    submits: state.submits,
    errors: state.errors
  };
  state.sessionLogs.push(logEntry);
  renderLog();

  state.running = false;
  updateButtons();
  updateMetrics();
  setMsg("Série terminée ✅ (log ajouté)", "good");
}

function renderLog(){
  if(state.sessionLogs.length === 0){
    ui.log.textContent = "";
    return;
  }
  const lines = state.sessionLogs.slice().reverse().map(e=>{
    const ini = (e.initiationMs === "" ? "—" : fmtMs(Number(e.initiationMs)));
    const tot = fmtMs(Number(e.totalMs));
    return `[${e.timestampISO}] sujet=${e.subjectId||"—"} age=${e.age||"—"} mode=${e.mode} niveau=${e.level} item=${e.itemId} | init=${ini} total=${tot} clics=${e.clicks} val=${e.submits} err=${e.errors}`;
  });
  ui.log.textContent = lines.join("\n");
}

function validate(){
  if(!state.running) return;
  if(state.selected.size !== 4) return;

  state.submits += 1;

  const grp = selectedGroupIdx();
  if(grp == null){
    state.errors += 1;
    if(state.mode === "train"){
      setMsg("✗ Mauvaise combinaison", "bad");
    }else{
      setMsg("✗", "bad");
    }
    state.selected.clear();
    render();
    updateButtons();
    return;
  }

  // déjà trouvé ?
  if(state.foundGroups.includes(grp)){
    setMsg("Déjà trouvé.", "warn");
    state.selected.clear();
    render();
    updateButtons();
    return;
  }

  // bon !
  state.foundGroups.push(grp);
  lockGroup(grp);
  addFoundCard(grp);

  if(state.mode === "train"){
    setMsg(`✓ Catégorie trouvée : ${state.currentItem.groups[grp].name}`, "good");
  }else{
    setMsg("✓", "good");
  }

  state.selected.clear();
  render();
  updateButtons();

  if(state.foundGroups.length === 4){
    // en mode entraînement, afficher aussi les catégories
    if(state.mode === "train"){
      ui.answerHint.textContent = state.currentItem.groups
        .map(g=>`${g.name} : ${g.words.join(", ")}`).join(" — ");
    }
    finishSeries();
  }
}

/** =========================
 *  CORRECTION (train)
 *  ========================= */
function reveal(){
  if(!state.running) return;
  if(state.mode !== "train") return;
  ui.answerHint.textContent = state.currentItem.groups
    .map(g=>`${g.name} : ${g.words.join(", ")}`).join(" — ");
  setMsg("Correction affichée (panneau de droite).", "warn");
}

/** =========================
 *  EXPORT CSV
 *  ========================= */
function toCSV(rows){
  const headers = [
    "timestampISO","subjectId","age","mode","level","itemId","seriesNumber",
    "initiationMs","totalMs","clicks","submits","errors"
  ];
  const esc = (v)=>{
    const s = String(v ?? "");
    if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };
  const out = [headers.join(",")];
  for(const r of rows){
    out.push(headers.map(h=>esc(r[h])).join(","));
  }
  return out.join("\n");
}
function exportCSV(){
  const csv = toCSV(state.sessionLogs);
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "connections_logs.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/** =========================
 *  UX: démarrage / validation
 *  ========================= */
ui.startBtn.onclick = ()=>{
  // si mode test, exiger un ID sujet
  if(ui.mode.value === "test"){
    const subj = ui.subjectId.value.trim();
    if(!subj){
      setMsg("En mode test, merci de renseigner l’ID du sujet.", "warn");
      ui.subjectId.focus();
      return;
    }
  }
  startSeries();
  ui.newBtn.disabled = false;
  ui.resetBtn.disabled = false;
};

ui.newBtn.onclick = ()=>{
  if(ui.mode.value === "test"){
    const subj = ui.subjectId.value.trim();
    if(!subj){
      setMsg("En mode test, merci de renseigner l’ID du sujet.", "warn");
      ui.subjectId.focus();
      return;
    }
  }
  startSeries();
};

ui.resetBtn.onclick = ()=>{
  resetSeriesOnly();
};

ui.validateBtn.onclick = validate;

ui.clearSelBtn.onclick = ()=>{
  state.selected.clear();
  render();
  updateButtons();
  setMsg("Sélection effacée.", "");
};

ui.revealBtn.onclick = reveal;

ui.exportBtn.onclick = exportCSV;

ui.mode.onchange = ()=>{
  // en test : bouton correction désactivé, feedback minimal
  updateButtons();
};

document.addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    if(!ui.validateBtn.disabled) validate();
  }
});

/** init */
setMsg("Prêt. Cliquez sur Démarrer.", "");
updateButtons();
renderLog();
</script>
</body>
</html>
