<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cat√©gories ‚Äî 4x4 (mode tablette)</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --card2:#0f172a;
      --text:#e8eefc;
      --muted:#a9b7da;
      --accent:#60a5fa;
      --good:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;
      --tile:#1a2540;
      --tile2:#22305a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% 0%, #13224a 0%, var(--bg) 55%) fixed;
      color:var(--text);
    }
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }
    header{
      display:flex;
      gap:12px;
      align-items:stretch;
      flex-wrap:wrap;
      margin-bottom:14px;
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 12px 14px;
    }
    .panel h1{
      font-size: 18px;
      margin:0 0 6px 0;
      letter-spacing:.2px;
    }
    .row{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .row label{
      font-size: 13px;
      color: var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
      background: rgba(255,255,255,.04);
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.07);
    }
    input[type="text"], select{
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      outline:none;
      min-width: 140px;
    }
    input[type="checkbox"]{ transform: scale(1.2); }
    .btn{
      background: rgba(96,165,250,.18);
      border: 1px solid rgba(96,165,250,.45);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 650;
      letter-spacing:.2px;
      user-select:none;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
    }
    .btn.danger{
      background: rgba(251,113,133,.16);
      border: 1px solid rgba(251,113,133,.40);
    }

    main{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width: 900px){
      main{ grid-template-columns: 1fr; }
    }

    .gridCard{ padding: 14px; }
    .statsCard{ padding: 14px; }

    .topline{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .kpi{
      display:flex; gap:10px; flex-wrap:wrap;
      font-size: 13px;
      color: var(--muted);
    }
    .kpi b{ color: var(--text); font-weight: 750; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
    }
    .pill .dot{
      width:10px; height:10px; border-radius: 50%;
      background: rgba(255,255,255,.25);
    }
    .pill.good .dot{ background: var(--good); }
    .pill.bad .dot{ background: var(--bad); }
    .pill.warn .dot{ background: var(--warn); }

    .grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .tile{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 16px 10px;
      min-height: 64px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-size: clamp(16px, 2.4vw, 20px);
      font-weight: 800;
      letter-spacing:.2px;
      user-select:none;
      cursor:pointer;
      touch-action: manipulation;
      position:relative;
      transition: transform .06s ease, border-color .15s ease, background .15s ease, opacity .15s ease;
    }
    .tile:active{ transform: scale(.99); }
    .tile.selected{
      outline: 3px solid rgba(96,165,250,.85);
      border-color: rgba(96,165,250,.85);
      background: linear-gradient(180deg, rgba(96,165,250,.18), rgba(96,165,250,.10));
    }
    /* "Utilis√©" = gris√© MAIS toujours cliquable */
    .tile.used{
      opacity: .55;
      filter: grayscale(.3);
    }

    .hint{
      margin-top: 12px;
      font-size: 13px;
      color: var(--muted);
      line-height:1.35;
    }
    .bigMsg{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      font-size: 14px;
      color: var(--text);
      min-height: 44px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .bigMsg .tag{
      font-weight: 850;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--muted);
    }
    .bigMsg .tag.good{ color: #052e1b; background: rgba(52,211,153,.85); border-color: rgba(52,211,153,.2); }
    .bigMsg .tag.bad{ color: #3b0a12; background: rgba(251,113,133,.9); border-color: rgba(251,113,133,.2); }
    .list{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .catLine{
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .catLine .left{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      font-weight: 800;
    }
    .badge .n{
      width: 26px; height: 26px; border-radius: 10px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(96,165,250,.22);
      border: 1px solid rgba(96,165,250,.35);
      font-weight: 900;
    }
    .ok{
      color: var(--good);
      font-weight: 900;
    }
    .muted{ color: var(--muted); }

    dialog{
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      background: rgba(16,24,44,.96);
      color: var(--text);
      box-shadow: var(--shadow);
      padding: 0;
      max-width: 560px;
      width: calc(100% - 28px);
    }
    dialog::backdrop{ background: rgba(0,0,0,.55); }
    .dlg{
      padding: 16px 16px 14px;
    }
    .dlg h2{ margin:0 0 8px 0; font-size: 18px; }
    .dlg p{ margin:0 0 12px 0; color: var(--muted); line-height:1.35; }
    .dlg .actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      padding-top: 8px;
    }
    .small{
      font-size: 12px;
      color: var(--muted);
    }
  </style>
</head>

<body>
  <div class="wrap">

    <header>
      <div class="panel" style="flex:1 1 520px;">
        <h1>Jeu de cat√©gorisation ‚Äî 4√ó4 (mode tablette)</h1>
        <div class="row">
          <label>ID sujet
            <input id="subjectId" type="text" placeholder="ex. S-001" />
          </label>
          <label>Mode entra√Ænement
            <input id="trainingMode" type="checkbox" />
          </label>
          <button class="btn secondary" id="btnRestartLevel">Recommencer le niveau</button>
          <button class="btn danger" id="btnResetAll">R√©initialiser session</button>
        </div>
        <div class="hint">
          R√®gle : s√©lectionnez <b>4 mots</b> puis validez. Chaque niveau = <b>4 validations max</b>.
          On passe automatiquement au niveau suivant (juste ou faux). <br/>
          Score : +1 par cat√©gorie correctement d√©tect√©e (nouvelle). Badge : 1 badge si les 4 cat√©gories sont trouv√©es.
        </div>
      </div>

      <div class="panel" style="flex:1 1 320px;">
        <h1>Export donn√©es</h1>
        <div class="row">
          <button class="btn" id="btnExportCsv">T√©l√©charger CSV</button>
          <button class="btn secondary" id="btnCopyJson">Copier JSON</button>
        </div>
        <div class="small" style="margin-top:10px;">
          Les donn√©es restent sur l‚Äôappareil (pas d‚Äôenvoi serveur). Le CSV contient les mesures par niveau.
        </div>
      </div>
    </header>

    <main>
      <section class="panel gridCard">
        <div class="topline">
          <div class="kpi">
            <span class="pill"><span class="dot"></span> Niveau <b id="lvlLabel">1</b>/<span id="lvlTotal">30</span></span>
            <span class="pill"><span class="dot"></span> Validations <b id="triesLabel">0</b>/4</span>
            <span class="pill"><span class="dot"></span> Cat√©gories trouv√©es <b id="foundLabel">0</b>/4</span>
          </div>
          <div class="kpi">
            <span class="pill good"><span class="dot"></span> Score <b id="scoreLabel">0</b></span>
            <span class="pill warn"><span class="dot"></span> Badges <b id="badgeLabel">0</b></span>
            <span class="pill bad"><span class="dot"></span> Niveaux √©chou√©s <b id="failLabel">0</b>/3</span>
          </div>
        </div>

        <div class="bigMsg" id="messageBox">
          <span class="tag">Info</span>
          <span id="messageText">S√©lectionnez 4 mots, puis validez.</span>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="btnValidate">Valider les 4 mots</button>
          <button class="btn secondary" id="btnClear">Effacer s√©lection</button>
          <span class="muted" id="selCount">0/4</span>
        </div>

        <div class="grid" id="grid"></div>
      </section>

      <aside class="panel statsCard">
        <h1>R√©sultats du niveau</h1>
        <div class="list" id="catsList"></div>

        <div class="hint" style="margin-top:12px;">
          <b>Mesures</b> (automatiques) : d√©lai d‚Äôinitiation, temps total, nb de validations, erreurs, etc.
        </div>
        <div class="list" style="margin-top:10px;">
          <div class="catLine">
            <div class="left"><span class="badge"><span class="n">‚è±</span> D√©lai d‚Äôinitiation</span></div>
            <div><b id="initDelay">‚Äî</b></div>
          </div>
          <div class="catLine">
            <div class="left"><span class="badge"><span class="n">‚åõ</span> Temps total niveau</span></div>
            <div><b id="totalTime">‚Äî</b></div>
          </div>
          <div class="catLine">
            <div class="left"><span class="badge"><span class="n">üß©</span> Validations</span></div>
            <div><b id="valCount">0</b></div>
          </div>
          <div class="catLine">
            <div class="left"><span class="badge"><span class="n">‚ö†</span> Erreurs</span></div>
            <div><b id="errCount">0</b></div>
          </div>
        </div>
      </aside>
    </main>

    <dialog id="dlgStop">
      <div class="dlg">
        <h2>Stop (3 niveaux √©chou√©s)</h2>
        <p>
          Vous avez atteint <b>3 niveaux √©chou√©s</b>. Voulez-vous continuer (tests aux limites) ou arr√™ter la session ?
        </p>
        <div class="actions">
          <button class="btn secondary" id="btnStopNow">Arr√™ter</button>
          <button class="btn" id="btnContinue">Continuer</button>
        </div>
      </div>
    </dialog>

    <dialog id="dlgEnd">
      <div class="dlg">
        <h2>Session termin√©e</h2>
        <p id="endSummary"></p>
        <div class="actions">
          <button class="btn" id="btnCloseEnd">Fermer</button>
        </div>
      </div>
    </dialog>

  </div>

<script>
/* =========================
   30 NIVEAUX (exemples)
   - Chaque niveau : 4 cat√©gories, 4 mots chacune
   - Ordre suppos√© croissant (√† affiner avec vous)
   ========================= */
const LEVELS = [
  // 1-6 : 6-7 ans (tr√®s simple)
  {cats:[
    {name:"Animaux", words:["chat","chien","lapin","poisson"]},
    {name:"Fruits", words:["pomme","banane","poire","orange"]},
    {name:"Couleurs", words:["rouge","bleu","vert","jaune"]},
    {name:"V√™tements", words:["pull","pantalon","chaussette","manteau"]}
  ]},
  {cats:[
    {name:"√âcole", words:["crayon","gomme","cahier","r√®gle"]},
    {name:"Cuisine", words:["assiette","cuill√®re","fourchette","verre"]},
    {name:"Transports", words:["bus","train","v√©lo","voiture"]},
    {name:"Corps", words:["main","pied","nez","oreille"]}
  ]},
  {cats:[
    {name:"M√©t√©o", words:["pluie","neige","vent","soleil"]},
    {name:"Boissons", words:["eau","lait","jus","th√©"]},
    {name:"Meubles", words:["chaise","table","lit","armoire"]},
    {name:"Jeux", words:["puzzle","ballon","lego","cartes"]}
  ]},
  {cats:[
    {name:"Lieux", words:["√©cole","maison","parc","magasin"]},
    {name:"Insectes", words:["fourmi","abeille","mouche","papillon"]},
    {name:"Formes", words:["rond","carr√©","triangle","rectangle"]},
    {name:"Saisons", words:["√©t√©","hiver","printemps","automne"]}
  ]},
  {cats:[
    {name:"Petit-d√©jeuner", words:["pain","beurre","c√©r√©ales","confiture"]},
    {name:"Jardin", words:["fleur","herbe","arbre","feuille"]},
    {name:"Bruits", words:["cloche","sir√®ne","tambour","sifflet"]},
    {name:"Sports", words:["foot","tennis","natation","judo"]}
  ]},
  {cats:[
    {name:"Contraires (adjectifs)", words:["grand","petit","chaud","froid"]},
    {name:"Animaux de ferme", words:["vache","poule","cochon","mouton"]},
    {name:"Outils simples", words:["marteau","scie","clou","vis"]},
    {name:"Go√ªts", words:["sucr√©","sal√©","amer","acide"]}
  ]},

  // 7-12 : 8-10 ans (un cran)
  {cats:[
    {name:"Verbes d‚Äôaction", words:["courir","sauter","lire","√©crire"]},
    {name:"Plan√®tes", words:["mars","v√©nus","terre","jupiter"]},
    {name:"Instruments", words:["piano","guitare","fl√ªte","violon"]},
    {name:"√âmotions", words:["joie","peur","col√®re","tristesse"]}
  ]},
  {cats:[
    {name:"Mat√©riaux", words:["bois","m√©tal","verre","plastique"]},
    {name:"Unit√©s de temps", words:["seconde","minute","heure","jour"]},
    {name:"Mer", words:["vague","mar√©e","algue","coquillage"]},
    {name:"Montagne", words:["sommet","piste","neige","vall√©e"]}
  ]},
  {cats:[
    {name:"Synonymes de parler", words:["dire","raconter","annoncer","expliquer"]},
    {name:"√ânergie", words:["soleil","vent","eau","p√©trole"]},
    {name:"Lecture", words:["roman","conte","po√®me","bande dessin√©e"]},
    {name:"Mesures", words:["m√®tre","litre","kilo","degr√©"]}
  ]},
  {cats:[
    {name:"Sports avec ballon", words:["basket","hand","rugby","volley"]},
    {name:"Oiseaux", words:["aigle","pigeon","moineau","hibou"]},
    {name:"Rivi√®res", words:["source","courant","berge","pont"]},
    {name:"Maison (pi√®ces)", words:["cuisine","salon","chambre","salle de bain"]}
  ]},
  {cats:[
    {name:"Mots de politesse", words:["bonjour","merci","pardon","s‚Äôil vous pla√Æt"]},
    {name:"Outils num√©riques", words:["clavier","souris","√©cran","imprimante"]},
    {name:"G√©om√©trie", words:["angle","segment","cercle","sym√©trie"]},
    {name:"Cuisine (cuisson)", words:["bouillir","griller","frire","cuire"]}
  ]},
  {cats:[
    {name:"√âcosyst√®me for√™t", words:["tronc","mousse","renard","champignon"]},
    {name:"√âtat de la mati√®re", words:["solide","liquide","gaz","vapeur"]},
    {name:"Langage", words:["syllabe","phrase","verbe","nom"]},
    {name:"Armes m√©di√©vales", words:["√©p√©e","arc","lance","bouclier"]}
  ]},

  // 13-20 : 11-13 ans (abstractions)
  {cats:[
    {name:"Causes/cons√©quences", words:["donc","car","puisque","ainsi"]},
    {name:"Valeurs", words:["courage","justice","respect","honn√™tet√©"]},
    {name:"√âlectricit√©", words:["ampoule","pile","courant","circuit"]},
    {name:"Grammaire (fonctions)", words:["sujet","COD","COI","compl√©ment"]}
  ]},
  {cats:[
    {name:"√âconomie", words:["prix","budget","√©pargne","d√©pense"]},
    {name:"Statut juridique", words:["loi","contrat","tribunal","droit"]},
    {name:"Probabilit√©", words:["hasard","chance","risque","al√©atoire"]},
    {name:"Astronomie", words:["orbite","√©toile","galaxie","com√®te"]}
  ]},
  {cats:[
    {name:"M√©taphores courantes", words:["c≈ìur","racine","lumi√®re","chemin"]},
    {name:"Sant√©", words:["sympt√¥me","diagnostic","traitement","pr√©vention"]},
    {name:"Cartographie", words:["√©chelle","l√©gende","boussole","latitude"]},
    {name:"Musique (th√©orie)", words:["tempo","rythme","accord","m√©lodie"]}
  ]},
  {cats:[
    {name:"Rh√©torique", words:["argument","exemple","conclusion","objection"]},
    {name:"Sciences (d√©marche)", words:["hypoth√®se","mesure","r√©sultat","variable"]},
    {name:"√ânergie (transfo)", words:["chimique","m√©canique","thermique","√©lectrique"]},
    {name:"Biologie", words:["cellule","organe","tissu","esp√®ce"]}
  ]},
  {cats:[
    {name:"Temps historique", words:["si√®cle","√©poque","antiquit√©","r√©volution"]},
    {name:"G√©opolitique", words:["fronti√®re","alli√©","conflit","trait√©"]},
    {name:"Logique", words:["si","alors","sinon","n√©cessaire"]},
    {name:"Maths (proportions)", words:["ratio","pourcentage","fraction","√©chelle"]}
  ]},
  {cats:[
    {name:"Psychologie", words:["attention","m√©moire","√©motion","motivation"]},
    {name:"Litt√©rature", words:["narrateur","intrigue","personnage","style"]},
    {name:"Informatique", words:["algorithme","donn√©e","r√©seau","programme"]},
    {name:"Chimie", words:["atome","mol√©cule","r√©action","solution"]}
  ]},
  {cats:[
    {name:"Soci√©t√©", words:["norme","culture","tradition","identit√©"]},
    {name:"√âthique", words:["devoir","bien","mal","responsabilit√©"]},
    {name:"Philo (connaissance)", words:["preuve","opinion","v√©rit√©","doute"]},
    {name:"Communication", words:["message","canal","contexte","intention"]}
  ]},
  {cats:[
    {name:"Statistiques", words:["moyenne","m√©diane","√©cart","fr√©quence"]},
    {name:"Narration (temps)", words:["flashback","ellipse","chronologie","point de vue"]},
    {name:"√âcologie", words:["biodiversit√©","pollution","climat","ressource"]},
    {name:"Conflit", words:["tension","enjeu","n√©gociation","compromis"]}
  ]},

  // 21-30 : 14-16 ans (plus complexe)
  {cats:[
    {name:"√âpist√©mologie", words:["mod√®le","th√©orie","falsifiable","paradigme"]},
    {name:"Droit du travail", words:["contrat","licenciement","prud‚Äôhommes","pr√©avis"]},
    {name:"√âconomie (macro)", words:["inflation","croissance","d√©ficit","ch√¥mage"]},
    {name:"Logique formelle", words:["implication","contradiction","axiome","validit√©"]}
  ]},
  {cats:[
    {name:"S√©mantique", words:["sens","r√©f√©rence","ambigu√Øt√©","connotation"]},
    {name:"M√©thodo recherche", words:["√©chantillon","normes","validit√©","fiabilit√©"]},
    {name:"Neuropsy", words:["inhibition","flexibilit√©","planification","m√©moire de travail"]},
    {name:"Argumentation", words:["th√®se","antith√®se","synth√®se","dialectique"]}
  ]},
  {cats:[
    {name:"Histoire (processus)", words:["colonisation","industrialisation","s√©cularisation","globalisation"]},
    {name:"Politique", words:["souverainet√©","l√©gitimit√©","institution","citoyennet√©"]},
    {name:"√âconomie (micro)", words:["incitation","co√ªt marginal","offre","demande"]},
    {name:"Mod√©lisation", words:["variable latente","param√®tre","pr√©diction","ajustement"]}
  ]},
  {cats:[
    {name:"Cognition sociale", words:["th√©orie de l‚Äôesprit","empathie","biais","attribution"]},
    {name:"√âvaluation", words:["√©talonnage","score brut","percentile","z-score"]},
    {name:"Texte (structure)", words:["implicite","pr√©suppos√©","coh√©rence","inf√©rence"]},
    {name:"Raisonnement", words:["analogie","abstraction","cat√©gorisation","g√©n√©ralisation"]}
  ]},
  {cats:[
    {name:"Philo morale", words:["utilitarisme","d√©ontologie","vertu","cons√©quentialisme"]},
    {name:"Science data", words:["feature","overfitting","validation crois√©e","distribution"]},
    {name:"Langage", words:["m√©taphore","m√©tonymie","polys√©mie","pragmatique"]},
    {name:"Syst√®mes", words:["r√©troaction","√©mergence","complexit√©","stabilit√©"]}
  ]},
  {cats:[
    {name:"Psychom√©trie", words:["alpha","item","variance","standardisation"]},
    {name:"M√©moire", words:["encodage","consolidation","r√©cup√©ration","interf√©rence"]},
    {name:"D√©cision", words:["heuristique","aversion","b√©n√©fice","probabilit√©"]},
    {name:"Philo (esprit)", words:["intentionnalit√©","conscience","qualia","repr√©sentation"]}
  ]},
  {cats:[
    {name:"√âconomie comportementale", words:["nudge","biais d‚Äôancrage","prospect","rationalit√© limit√©e"]},
    {name:"√âthique (soin)", words:["vuln√©rabilit√©","sollicitude","relation","d√©pendance"]},
    {name:"M√©thodes stats", words:["r√©gression","corr√©lation","p-valeur","intervalle"]},
    {name:"Sociologie", words:["habitus","champ","capital","reproduction"]}
  ]},
  {cats:[
    {name:"Histoire (sources)", words:["archive","t√©moignage","historiographie","critique"]},
    {name:"Logique (preuves)", words:["induction","d√©duction","abduction","contre-exemple"]},
    {name:"Neurosciences", words:["synapse","plasticit√©","r√©seau","my√©line"]},
    {name:"Analyse texte", words:["th√®me","motif","registre","√©nonciation"]}
  ]},
  {cats:[
    {name:"Th√©orie des syst√®mes", words:["entropie","bifurcation","attracteur","non-lin√©aire"]},
    {name:"Philo (science)", words:["r√©alisme","instrumentalisme","cumulativit√©","rupture"]},
    {name:"Mesure", words:["invariance","√©talonnage","biais","erreur"]},
    {name:"Cognition", words:["chunking","sch√©ma","charge cognitive","automatisation"]}
  ]},
  {cats:[
    {name:"Meta-cognition", words:["monitoring","contr√¥le","confiance","calibration"]},
    {name:"Validit√©", words:["contenu","construct","crit√®re","√©cologique"]},
    {name:"Raisonnement avanc√©", words:["transfert","isomorphisme","contraste","hi√©rarchie"]},
    {name:"√âthique (donn√©es)", words:["consentement","anonymisation","finalit√©","proportionnalit√©"]}
  ]},
];

// --- util ---
const $ = (id)=>document.getElementById(id);
const fmtMs = (ms)=>{
  if(ms==null) return "‚Äî";
  const s = Math.max(0, Math.round(ms/100)/10); // 0.1s
  return `${s.toFixed(1)} s`;
};
const now = ()=>performance.now();

// --- √©tat session ---
let session = {
  subjectId: "",
  trainingMode: false,
  startedAt: new Date().toISOString(),
  score: 0,
  badges: 0,
  failedLevels: 0,
  currentLevelIndex: 0, // 0-based
  logs: [] // one object per level
};

let levelState = null;

function newLevelState(levelIdx){
  const lvl = LEVELS[levelIdx];
  const words = lvl.cats.flatMap(c=>c.words).slice();
  // Shuffle
  for(let i=words.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [words[i],words[j]]=[words[j],words[i]];
  }

  return {
    levelIdx,
    levelStartPerf: now(),
    firstTapPerf: null,
    totalValidations: 0,
    errors: 0,
    foundCats: new Set(),
    // for "new category only" scoring
    foundCatsByName: new Set(),
    // keep track of submitted groups for logs
    submissions: [],
    // UI state
    tiles: words.map((w, i)=>({ id:i, word:w, selected:false, used:false }))
  };
}

function setMessage(type, text, tagText){
  const box = $("messageBox");
  const tag = box.querySelector(".tag");
  const msg = $("messageText");
  tag.classList.remove("good","bad");
  tag.textContent = tagText || "Info";
  if(type==="good") tag.classList.add("good");
  if(type==="bad") tag.classList.add("bad");
  msg.textContent = text;
}

function render(){
  // header stats
  $("lvlLabel").textContent = (session.currentLevelIndex+1);
  $("lvlTotal").textContent = LEVELS.length;
  $("triesLabel").textContent = levelState.totalValidations;
  $("foundLabel").textContent = levelState.foundCatsByName.size;
  $("scoreLabel").textContent = session.score;
  $("badgeLabel").textContent = session.badges;
  $("failLabel").textContent = session.failedLevels;

  // measures
  const initDelay = levelState.firstTapPerf ? (levelState.firstTapPerf - levelState.levelStartPerf) : null;
  $("initDelay").textContent = fmtMs(initDelay);
  $("valCount").textContent = levelState.totalValidations;
  $("errCount").textContent = levelState.errors;
  const elapsed = now() - levelState.levelStartPerf;
  $("totalTime").textContent = fmtMs(elapsed);

  // cats list (progress)
  const lvl = LEVELS[levelState.levelIdx];
  const list = $("catsList");
  list.innerHTML = "";
  lvl.cats.forEach((c, idx)=>{
    const ok = levelState.foundCatsByName.has(c.name);
    const div = document.createElement("div");
    div.className = "catLine";
    div.innerHTML = `
      <div class="left">
        <span class="badge"><span class="n">${idx+1}</span> ${c.name}</span>
        ${ok ? `<span class="ok">‚úî trouv√©</span>` : `<span class="muted">‚Äî</span>`}
      </div>
      <div class="muted">${session.trainingMode ? c.words.join(" ¬∑ ") : ""}</div>
    `;
    list.appendChild(div);
  });

  // grid
  const grid = $("grid");
  grid.innerHTML = "";
  levelState.tiles.forEach(t=>{
    const btn = document.createElement("div");
    btn.className = "tile";
    if(t.selected) btn.classList.add("selected");
    if(t.used) btn.classList.add("used");
    btn.textContent = t.word;
    btn.addEventListener("click", ()=>toggleTile(t.id));
    grid.appendChild(btn);
  });

  // selection count
  const sel = levelState.tiles.filter(x=>x.selected).length;
  $("selCount").textContent = `${sel}/4`;
}

function toggleTile(id){
  if(!levelState.firstTapPerf) levelState.firstTapPerf = now();

  const tile = levelState.tiles.find(t=>t.id===id);
  if(!tile) return;

  const selCount = levelState.tiles.filter(t=>t.selected).length;
  if(!tile.selected && selCount>=4){
    setMessage("bad","Vous avez d√©j√† 4 mots. Validez ou d√©s√©lectionnez-en un.","Limite");
    render();
    return;
  }
  tile.selected = !tile.selected;
  render();
}

function clearSelection(){
  levelState.tiles.forEach(t=>t.selected=false);
  setMessage("","S√©lectionnez 4 mots, puis validez.","Info");
  render();
}

function evaluateSelection(selectedWords){
  const lvl = LEVELS[levelState.levelIdx];
  // Find matching category (exact set)
  for(const cat of lvl.cats){
    const catSet = new Set(cat.words);
    let ok = true;
    for(const w of selectedWords){
      if(!catSet.has(w)) { ok=false; break; }
    }
    if(ok && selectedWords.length===4){
      // also ensure cat has exactly these 4 (it does)
      return {match:true, catName: cat.name};
    }
  }
  return {match:false, catName:null};
}

/* ---- BUG FIX PRINCIPAL ----
   - On NE PASSE PAS au niveau suivant apr√®s 3 cat√©gories trouv√©es.
   - Un niveau se termine :
       a) si 4 cat√©gories sont trouv√©es (badge, fin imm√©diate)
       b) sinon apr√®s 4 validations (grille "compl√®te" justes ou fausses)
*/
function maybeEndLevel(){
  const found = levelState.foundCatsByName.size;

  // Fin imm√©diate si les 4 cat√©gories sont trouv√©es
  if(found >= 4){
    session.badges += 1;
    setMessage("good","Bravo : les 4 cat√©gories sont trouv√©es ! Badge gagn√©. Passage au niveau suivant‚Ä¶","Badge");
    finalizeLevel(true);
    return;
  }

  // Sinon, fin du niveau apr√®s 4 validations
  if(levelState.totalValidations >= 4){
    const success = (found === 4);
    if(!success){
      session.failedLevels += 1;
      setMessage("bad","Niveau termin√© (4 validations). Passage au niveau suivant‚Ä¶","Fin niveau");
    }
    finalizeLevel(success);
  }
}

function finalizeLevel(success){
  // log level data
  const initDelay = levelState.firstTapPerf ? (levelState.firstTapPerf - levelState.levelStartPerf) : null;
  const totalTime = now() - levelState.levelStartPerf;

  session.logs.push({
    ts: new Date().toISOString(),
    subjectId: session.subjectId,
    trainingMode: session.trainingMode,
    levelNumber: levelState.levelIdx + 1,
    levelSuccessAll4: success,
    scoreAfter: session.score,
    badgesAfter: session.badges,
    failedLevelsAfter: session.failedLevels,
    initDelayMs: initDelay,
    totalTimeMs: totalTime,
    validations: levelState.totalValidations,
    errors: levelState.errors,
    categoriesFoundCount: levelState.foundCatsByName.size,
    categoriesFound: Array.from(levelState.foundCatsByName),
    submissions: levelState.submissions
  });

  // stop rule: after 3 failed levels ask to continue/stop
  if(session.failedLevels >= 3){
    $("dlgStop").showModal();
    return;
  }

  // next level
  goNextLevel();
}

function goNextLevel(){
  // if last level -> end
  if(session.currentLevelIndex >= LEVELS.length-1){
    endSession();
    return;
  }
  session.currentLevelIndex += 1;
  levelState = newLevelState(session.currentLevelIndex);
  setMessage("","Nouveau niveau : s√©lectionnez 4 mots, puis validez.","Info");
  render();
}

function endSession(){
  const summary = `Score brut : ${session.score} ‚Äî Badges : ${session.badges} ‚Äî Niveaux √©chou√©s : ${session.failedLevels}.
Vous pouvez exporter le CSV pour l‚Äô√©talonnage.`;
  $("endSummary").textContent = summary;
  $("dlgEnd").showModal();
}

function validate(){
  const selected = levelState.tiles.filter(t=>t.selected);
  if(selected.length !== 4){
    setMessage("bad","Il faut s√©lectionner exactement 4 mots.","Erreur");
    render();
    return;
  }
  if(!levelState.firstTapPerf) levelState.firstTapPerf = now();

  const words = selected.map(t=>t.word);
  const evalRes = evaluateSelection(words);

  // mark used (gris√©) BUT keep clickable (r√©utilisable)
  selected.forEach(t=>{
    t.used = true;
    t.selected = false;
  });

  const submission = {
    tMs: now() - levelState.levelStartPerf,
    words
  };

  levelState.totalValidations += 1;

  if(evalRes.match){
    submission.correct = true;
    submission.category = evalRes.catName;

    // points only if category not already found this level
    if(!levelState.foundCatsByName.has(evalRes.catName)){
      levelState.foundCatsByName.add(evalRes.catName);
      session.score += 1;
      setMessage("good",`Correct ‚úÖ Cat√©gorie : ${evalRes.catName} (+1 point).`,`Correct`);
    }else{
      // Already found, no new point
      setMessage("good",`Correct ‚úÖ (cat√©gorie d√©j√† trouv√©e) : ${evalRes.catName}.`,`Correct`);
    }
  }else{
    submission.correct = false;
    levelState.errors += 1;
    setMessage("bad","Incorrect ‚ùå Ce groupe ne correspond √† aucune cat√©gorie du niveau.","Erreur");
  }

  levelState.submissions.push(submission);

  render();
  maybeEndLevel();
}

function restartLevel(){
  levelState = newLevelState(session.currentLevelIndex);
  setMessage("","Niveau recommenc√©. S√©lectionnez 4 mots, puis validez.","Info");
  render();
}

function resetAll(){
  session = {
    subjectId: "",
    trainingMode: false,
    startedAt: new Date().toISOString(),
    score: 0,
    badges: 0,
    failedLevels: 0,
    currentLevelIndex: 0,
    logs: []
  };
  $("subjectId").value = "";
  $("trainingMode").checked = false;
  levelState = newLevelState(0);
  setMessage("","S√©lectionnez 4 mots, puis validez.","Info");
  render();
}

function exportCsv(){
  // Level-level CSV
  const rows = [];
  const header = [
    "ts","subjectId","trainingMode","levelNumber","levelSuccessAll4",
    "scoreAfter","badgesAfter","failedLevelsAfter",
    "initDelayMs","totalTimeMs","validations","errors","categoriesFoundCount",
    "categoriesFound","submissionsJson"
  ];
  rows.push(header.join(","));

  for(const log of session.logs){
    const line = [
      log.ts,
      csvSafe(log.subjectId),
      log.trainingMode ? "1":"0",
      log.levelNumber,
      log.levelSuccessAll4 ? "1":"0",
      log.scoreAfter,
      log.badgesAfter,
      log.failedLevelsAfter,
      numOrEmpty(log.initDelayMs),
      numOrEmpty(log.totalTimeMs),
      log.validations,
      log.errors,
      log.categoriesFoundCount,
      csvSafe(log.categoriesFound.join("|")),
      csvSafe(JSON.stringify(log.submissions))
    ];
    rows.push(line.join(","));
  }

  const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  const sid = (session.subjectId || "session").replace(/[^\w-]+/g,"_");
  a.download = `categories_${sid}_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function csvSafe(v){
  const s = (v ?? "").toString();
  const needs = /[",\n]/.test(s);
  const esc = s.replaceAll('"','""');
  return needs ? `"${esc}"` : esc;
}
function numOrEmpty(n){
  if(n==null || Number.isNaN(n)) return "";
  return Math.round(n);
}

async function copyJson(){
  const payload = JSON.stringify(session, null, 2);
  try{
    await navigator.clipboard.writeText(payload);
    setMessage("good","JSON copi√© dans le presse-papiers.","Export");
  }catch(e){
    setMessage("bad","Impossible de copier automatiquement. Essayez l‚Äôexport CSV.","Export");
  }
  render();
}

// --- hooks ---
$("btnValidate").addEventListener("click", validate);
$("btnClear").addEventListener("click", clearSelection);
$("btnRestartLevel").addEventListener("click", restartLevel);
$("btnResetAll").addEventListener("click", resetAll);
$("btnExportCsv").addEventListener("click", exportCsv);
$("btnCopyJson").addEventListener("click", copyJson);

$("subjectId").addEventListener("input", (e)=>{
  session.subjectId = e.target.value.trim();
});
$("trainingMode").addEventListener("change", (e)=>{
  session.trainingMode = !!e.target.checked;
  render();
});

// stop modal
$("btnContinue").addEventListener("click", ()=>{
  $("dlgStop").close();
  // allow continuing beyond 3 failed levels
  goNextLevel();
});
$("btnStopNow").addEventListener("click", ()=>{
  $("dlgStop").close();
  endSession();
});

// end modal
$("btnCloseEnd").addEventListener("click", ()=>{
  $("dlgEnd").close();
});

// init
levelState = newLevelState(0);
setMessage("","S√©lectionnez 4 mots, puis validez.","Info");
render();
</script>
</body>
</html>
