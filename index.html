<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Similitudes ‚Äî Cat√©gories (6‚Äì16 ans)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#111827;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:#243044;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --accent:#60a5fa;
      --tile:#0b1220;
      --tileHover:#111c33;
      --tileSel:#1f3b7a;
      --tileTried:#1f2937;
      --tileSolved:#14532d;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 30% 0%, #182444 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 28px;
    }
    header{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      background: rgba(17,24,39,.72);
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }
    .title{
      display:flex; flex-direction:column; gap:2px;
      min-width: 220px;
    }
    .title h1{
      margin:0;
      font-size: 18px;
      letter-spacing:.2px;
      font-weight: 700;
    }
    .title .sub{
      margin:0;
      font-size: 12.5px;
      color: var(--muted);
    }
    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .field{
      display:flex; flex-direction:column; gap:4px;
      min-width: 140px;
    }
    .field label{
      font-size: 11px;
      color: var(--muted);
    }
    input[type="text"]{
      height: 40px;
      padding: 0 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(15,23,42,.8);
      color: var(--text);
      outline:none;
      font-size: 14px;
    }
    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(15,23,42,.8);
      height: 40px;
      user-select:none;
    }
    .toggle input{transform: scale(1.2)}
    .btn{
      height: 40px;
      padding: 0 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(96,165,250,.18), rgba(96,165,250,.08));
      color: var(--text);
      font-weight: 700;
      letter-spacing:.2px;
      cursor:pointer;
      touch-action: manipulation;
    }
    .btn.secondary{
      background: rgba(15,23,42,.8);
      font-weight: 650;
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(239,68,68,.20), rgba(239,68,68,.10));
    }
    .btn:active{transform: translateY(1px)}
    .main{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
    }
    @media (max-width: 860px){
      .main{grid-template-columns: 1fr}
    }
    .card{
      background: rgba(17,24,39,.72);
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding: 12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .meta{
      display:flex; flex-direction:column; gap:4px;
    }
    .meta .line{
      font-size: 13px;
      color: var(--muted);
    }
    .meta strong{color:var(--text)}
    .scoreRow{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
      min-width: 180px;
    }
    .pillRow{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }
    .pill{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(15,23,42,.8);
      color: var(--muted);
      white-space:nowrap;
    }
    .pill.good{border-color: rgba(34,197,94,.35); color:#bbf7d0}
    .pill.bad{border-color: rgba(239,68,68,.35); color:#fecaca}
    .pill.warn{border-color: rgba(245,158,11,.40); color:#fde68a}
    .gridArea{
      padding: 12px;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      user-select:none;
      touch-action: manipulation;
    }
    .tile{
      position:relative;
      min-height: 74px;
      padding: 12px 10px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(11,18,32,.9), rgba(11,18,32,.65));
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-size: 16px;
      font-weight: 800;
      letter-spacing: .2px;
      cursor:pointer;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
    }
    .tile:active{transform: scale(.99)}
    .tile:hover{background: linear-gradient(180deg, rgba(17,28,51,.95), rgba(17,28,51,.70))}
    .tile.selected{
      border-color: rgba(96,165,250,.65);
      background: linear-gradient(180deg, rgba(31,59,122,.95), rgba(31,59,122,.65));
    }
    .tile.tried::after{
      content:"";
      position:absolute; inset:0;
      border-radius: 16px;
      background: rgba(148,163,184,.18);
      pointer-events:none;
    }
    .tile.solved{
      border-color: rgba(34,197,94,.60);
      background: linear-gradient(180deg, rgba(20,83,45,.92), rgba(20,83,45,.62));
    }
    .tile .tiny{
      position:absolute;
      top:8px; right:10px;
      font-size: 11px;
      color: rgba(255,255,255,.55);
      font-weight: 700;
    }
    .actions{
      display:flex;
      gap:10px;
      padding: 0 12px 12px;
    }
    .actions .btn{flex:1; height: 48px; border-radius: 16px; font-size: 15px;}
    .help{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .msg{
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(15,23,42,.72);
      color: var(--muted);
      line-height:1.35;
      font-size: 13px;
      min-height: 64px;
      display:flex;
      align-items:center;
    }
    .msg strong{color:var(--text)}
    .list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .cat{
      padding: 10px 10px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(15,23,42,.60);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .cat .name{
      font-weight: 800;
      font-size: 13.5px;
      color: var(--text);
    }
    .cat .status{
      font-size: 12px;
      color: var(--muted);
    }
    .cat.solved{
      border-color: rgba(34,197,94,.35);
      background: rgba(20,83,45,.30);
    }
    .cat.solved .status{color:#bbf7d0}
    .divider{
      height:1px;
      background: rgba(255,255,255,.08);
      margin: 6px 0;
    }
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width: min(520px, 100%);
      background: rgba(17,24,39,.92);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal h2{margin:0; font-size: 16px; padding: 14px 14px 8px;}
    .modal p{margin:0; padding: 0 14px 14px; color: var(--muted); line-height:1.4; font-size: 13px;}
    .modal .row{
      display:flex; gap:10px; padding: 12px 14px 14px;
      border-top:1px solid rgba(255,255,255,.08);
    }
    .modal .row .btn{flex:1; height: 46px;}
    .footerNote{
      margin-top: 12px;
      color: rgba(255,255,255,.45);
      font-size: 11.5px;
      text-align:center;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Similitudes ‚Äî Cat√©gories</h1>
        <div class="sub">16 mots (4√ó4). Trouver 4 cat√©gories (4 mots chacune). Tablette/tactile OK.</div>
      </div>

      <div class="controls">
        <div class="field">
          <label for="subjectId">ID sujet</label>
          <input id="subjectId" type="text" placeholder="ex: HGL-001" />
        </div>

        <label class="toggle" title="En entra√Ænement : feedback plus explicite. En test : plus neutre.">
          <input id="trainingMode" type="checkbox" />
          <span>Entra√Ænement</span>
        </label>

        <button id="btnDownload" class="btn secondary" title="T√©l√©charger les donn√©es brutes (CSV)">T√©l√©charger CSV</button>
        <button id="btnReset" class="btn danger" title="R√©initialiser la session">Reset</button>
      </div>
    </header>

    <div class="main">
      <section class="card">
        <div class="cardHead">
          <div class="meta">
            <div class="line"><strong id="levelLabel">Niveau</strong> <span id="levelSpan"></span></div>
            <div class="line">Validations grille : <strong id="attemptsSpan">0</strong>/4 ¬∑ Cat√©gories trouv√©es : <strong id="foundSpan">0</strong>/4</div>
          </div>
          <div class="scoreRow">
            <div class="pillRow">
              <div class="pill good">Points: <strong id="pointsSpan">0</strong></div>
              <div class="pill warn">Badges: <strong id="badgesSpan">0</strong></div>
              <div class="pill">√âchecs suite: <strong id="failsSpan">0</strong>/3</div>
            </div>
            <div class="pillRow">
              <div class="pill">Init: <strong id="initSpan">‚Äî</strong></div>
              <div class="pill">Temps: <strong id="timeSpan">‚Äî</strong></div>
            </div>
          </div>
        </div>

        <div class="gridArea">
          <div id="grid" class="grid"></div>
        </div>

        <div class="actions">
          <button id="btnValidate" class="btn">Valider (4 mots)</button>
          <button id="btnNext" class="btn secondary">Suivant</button>
        </div>
      </section>

      <aside class="card">
        <div class="cardHead">
          <div class="meta">
            <div class="line"><strong>Cat√©gories de la grille</strong></div>
            <div class="line">En test, elles restent cach√©es (sauf apr√®s r√©ussite / en entra√Ænement).</div>
          </div>
        </div>

        <div class="help">
          <div id="message" class="msg">
            S√©lectionne <strong>exactement 4 mots</strong>, puis <strong>Valider</strong>.
          </div>

          <div class="divider"></div>

          <div id="catList" class="list"></div>

          <div class="divider"></div>

          <div class="msg">
            Astuce tactile : vise les cases, pas le texte üòâ
          </div>
        </div>
      </aside>
    </div>

    <div class="footerNote">
      Donn√©es stock√©es en m√©moire (dans le navigateur). Pense √† ‚ÄúT√©l√©charger CSV‚Äù √† la fin.
    </div>
  </div>

  <!-- Modal 3 √©checs -->
  <div id="modalBack" class="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <h2>3 grilles sans badge</h2>
      <p>
        Le sujet n‚Äôa pas trouv√© les 4 cat√©gories sur 3 grilles cons√©cutives.
        Voulez-vous <strong>continuer</strong> (test aux limites) ou <strong>arr√™ter</strong> ?
      </p>
      <div class="row">
        <button id="btnStop" class="btn danger">Arr√™ter</button>
        <button id="btnContinue" class="btn">Continuer</button>
      </div>
    </div>
  </div>

<script>
/**
 * BANQUE DE 30 CAT√âGORIES (croissance grossi√®re de complexit√©).
 * Chaque cat√©gorie fournit exactement 4 mots "corrects" (pour construire une grille 4x4 propre).
 * Les niveaux utilisent une fen√™tre glissante : niveau 1 = cat[0..3], niveau 2 = cat[1..4], etc.
 * => 27 niveaux au total.
 */
const CATEGORY_BANK = [
  // 6‚Äì7 ans (tr√®s concret / fr√©quent)
  {name:"Animaux de la ferme", words:["vache","poule","mouton","cheval"]},
  {name:"Fruits",            words:["pomme","banane","poire","orange"]},
  {name:"Couleurs",          words:["rouge","bleu","jaune","vert"]},
  {name:"V√™tements",         words:["pull","pantalon","chaussure","manteau"]},
  {name:"Meubles",           words:["table","chaise","lit","armoire"]},
  {name:"V√©hicules",         words:["voiture","bus","train","v√©lo"]},
  {name:"Parties du corps",  words:["main","pied","nez","oreille"]},
  {name:"√Ä l‚Äô√©cole",         words:["crayon","cahier","gomme","r√®gle"]},

  // 8‚Äì9 ans (cat√©gories plus ‚Äúscolaires‚Äù / regroupements usuels)
  {name:"Outils",            words:["marteau","scie","tournevis","pince"]},
  {name:"Instruments de musique", words:["piano","guitare","violon","fl√ªte"]},
  {name:"Sports",            words:["football","tennis","natation","basket"]},
  {name:"L√©gumes",           words:["carotte","tomate","courgette","poireau"]},
  {name:"Animaux sauvages",  words:["lion","tigre","z√®bre","girafe"]},
  {name:"Saisons",           words:["printemps","√©t√©","automne","hiver"]},
  {name:"Formes",            words:["cercle","carr√©","triangle","rectangle"]},
  {name:"Pi√®ces de la maison",words:["cuisine","salon","chambre","salle de bain"]},

  // 10‚Äì11 ans (cat√©gories plus abstraites / crit√®res)
  {name:"Synonymes de ‚Äúcontent‚Äù", words:["heureux","joyeux","ravi","satisfait"]},
  {name:"Moyens de communication",words:["email","t√©l√©phone","lettre","message"]},
  {name:"Mesures (unit√©s)",   words:["m√®tre","litre","kilo","seconde"]},
  {name:"M√©tiers de soin",    words:["m√©decin","infirmier","dentiste","kin√©"]},
  {name:"Verbes de mouvement",words:["courir","marcher","sauter","ramper"]},
  {name:"√âmotions",           words:["peur","col√®re","joie","tristesse"]},
  {name:"Mat√©riaux",          words:["bois","m√©tal","verre","plastique"]},
  {name:"Nature (√©l√©ments)",  words:["rivi√®re","montagne","for√™t","plage"]},

  // 12‚Äì13 ans (relations s√©mantiques, fonctions)
  {name:"Ce qui coupe",       words:["couteau","ciseaux","lame","scalpel"]},
  {name:"Ce qui √©claire",     words:["lampe","bougie","phare","lanterne"]},
  {name:"Ce qui prot√®ge",     words:["casque","gants","bouclier","masque"]},
  {name:"Genres litt√©raires", words:["roman","po√®me","th√©√¢tre","conte"]},
  {name:"Raisonnement (op√©rations)",words:["d√©duire","comparer","classer","inf√©rer"]},
  {name:"Connecteurs logiques",words:["donc","car","mais","pourtant"]},

  // 14‚Äì16 ans (cat√©gories plus ‚Äúm√©ta‚Äù, proches du vocabulaire scolaire avanc√©)
  {name:"Figures de style",   words:["m√©taphore","hyperbole","ironie","oxymore"]},
  {name:"Registres de langue",words:["familier","courant","soutenu","argotique"]},
  {name:"Types d‚Äôarguments",  words:["exemple","analogie","autorit√©","cons√©quence"]},
  {name:"Notions de temps",   words:["dur√©e","fr√©quence","simultan√©it√©","chronologie"]},
  {name:"Biais cognitifs",    words:["confirmation","ancrage","disponibilit√©","sunk cost"]},
  {name:"√âpist√©mologie (mots-cl√©s)",words:["hypoth√®se","preuve","th√©orie","falsification"]}
];

// Construire les niveaux (fen√™tre glissante de 4 cat√©gories)
const LEVELS = [];
for(let i=0;i<=CATEGORY_BANK.length-4;i++){
  LEVELS.push({
    idx: i+1,
    cats: [CATEGORY_BANK[i], CATEGORY_BANK[i+1], CATEGORY_BANK[i+2], CATEGORY_BANK[i+3]]
  });
}

const $ = sel => document.querySelector(sel);

const gridEl = $("#grid");
const catListEl = $("#catList");
const msgEl = $("#message");
const trainingEl = $("#trainingMode");

const levelSpan = $("#levelSpan");
const attemptsSpan = $("#attemptsSpan");
const foundSpan = $("#foundSpan");
const pointsSpan = $("#pointsSpan");
const badgesSpan = $("#badgesSpan");
const failsSpan = $("#failsSpan");
const initSpan = $("#initSpan");
const timeSpan = $("#timeSpan");

const btnValidate = $("#btnValidate");
const btnNext = $("#btnNext");
const btnReset = $("#btnReset");
const btnDownload = $("#btnDownload");

const modalBack = $("#modalBack");
const btnStop = $("#btnStop");
const btnContinue = $("#btnContinue");

let state = {
  sessionId: crypto.randomUUID(),
  startedAt: Date.now(),
  levelIndex: 0,                // 0..LEVELS-1
  points: 0,
  badges: 0,
  consecutiveFails: 0,

  // niveau courant
  gridStartAt: 0,
  firstClickAt: null,
  clickCount: 0,
  validateCount: 0,
  errorCount: 0,
  foundCats: new Set(),         // indices 0..3 des cat√©gories trouv√©es
  triedWordSet: new Set(),      // mots essay√©s (pour griser)
  selected: new Set(),          // indices des tuiles s√©lectionn√©es
  tiles: [],                    // {word, catIndex}
  ended: false,

  // logs d√©taill√©s
  logs: [] // {sessionId, subjectId, level, levelAbs, timestamp, event, data...}
};

function nowISO(){
  return new Date().toISOString();
}
function subjectId(){
  return ($("#subjectId").value || "").trim();
}
function log(event, data={}){
  state.logs.push({
    sessionId: state.sessionId,
    subjectId: subjectId(),
    ts: nowISO(),
    level: state.levelIndex+1,
    levelAbs: LEVELS[state.levelIndex]?.idx ?? null,
    event,
    ...data
  });
}

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function fmtMs(ms){
  if(ms==null) return "‚Äî";
  const s = Math.max(0, Math.round(ms/1000));
  const m = Math.floor(s/60);
  const r = s%60;
  return (m>0) ? `${m}m${String(r).padStart(2,'0')}s` : `${r}s`;
}

function openModal(){
  modalBack.style.display = "flex";
}
function closeModal(){
  modalBack.style.display = "none";
}

function buildLevel(){
  const L = LEVELS[state.levelIndex];
  if(!L){
    // Fin
    msgEl.innerHTML = `Fin des niveaux. Pense √† <strong>T√©l√©charger CSV</strong>.`;
    btnValidate.disabled = true;
    btnNext.disabled = true;
    gridEl.innerHTML = "";
    catListEl.innerHTML = "";
    return;
  }

  state.gridStartAt = Date.now();
  state.firstClickAt = null;
  state.clickCount = 0;
  state.validateCount = 0;
  state.errorCount = 0;
  state.foundCats = new Set();
  state.triedWordSet = new Set();
  state.selected = new Set();
  state.tiles = [];
  state.ended = false;

  // Construire 16 mots = 4 mots * 4 cat√©gories (pas de doublons attendus dans nos listes)
  const tiles = [];
  L.cats.forEach((cat, catIndex)=>{
    cat.words.forEach(w=>{
      tiles.push({word:w, catIndex});
    });
  });

  state.tiles = shuffle(tiles);

  // UI
  levelSpan.textContent = `${L.idx}/${LEVELS.length}`;
  attemptsSpan.textContent = "0";
  foundSpan.textContent = "0";
  initSpan.textContent = "‚Äî";
  timeSpan.textContent = "‚Äî";

  renderGrid();
  renderCatList();

  msgEl.innerHTML = `S√©lectionne <strong>4 mots</strong> puis <strong>Valider</strong>.`;
  btnValidate.disabled = false;
  btnNext.disabled = false;

  log("level_start", {
    categories: L.cats.map(c=>c.name),
    words: state.tiles.map(t=>t.word)
  });

  tickTime();
}

function renderGrid(){
  gridEl.innerHTML = "";
  state.tiles.forEach((t, idx)=>{
    const tile = document.createElement("div");
    tile.className = "tile";
    tile.setAttribute("data-idx", String(idx));
    tile.setAttribute("role","button");
    tile.setAttribute("tabindex","0");
    tile.innerHTML = `<span class="tiny">${idx+1}</span>${t.word}`;

    // √©tats visuels
    if(state.selected.has(idx)) tile.classList.add("selected");
    if(state.triedWordSet.has(t.word)) tile.classList.add("tried");
    if(state.foundCats.has(t.catIndex)) tile.classList.add("solved");

    tile.addEventListener("click", ()=> onTileTap(idx));
    tile.addEventListener("keydown", (e)=>{
      if(e.key==="Enter" || e.key===" "){
        e.preventDefault();
        onTileTap(idx);
      }
    });
    gridEl.appendChild(tile);
  });
}

function renderCatList(){
  const L = LEVELS[state.levelIndex];
  catListEl.innerHTML = "";

  L.cats.forEach((cat, i)=>{
    const row = document.createElement("div");
    const solved = state.foundCats.has(i);

    row.className = "cat" + (solved ? " solved" : "");
    const showNames = trainingEl.checked || solved; // cach√© en test tant que non trouv√©
    const label = showNames ? cat.name : `Cat√©gorie ${i+1}`;

    row.innerHTML = `
      <div class="name">${label}</div>
      <div class="status">${solved ? "Trouv√©e ‚úÖ" : "√Ä trouver"}</div>
    `;
    catListEl.appendChild(row);
  });
}

function onTileTap(idx){
  if(state.ended) return;

  if(state.firstClickAt == null){
    state.firstClickAt = Date.now();
    initSpan.textContent = fmtMs(state.firstClickAt - state.gridStartAt);
    log("first_click", {ms: state.firstClickAt - state.gridStartAt});
  }

  state.clickCount++;
  const wasSelected = state.selected.has(idx);

  if(wasSelected){
    state.selected.delete(idx);
  }else{
    if(state.selected.size >= 4){
      // Limite: 4 max
      msgEl.innerHTML = `Tu as d√©j√† <strong>4 mots</strong>. D√©s√©lectionne-en un.`;
      return;
    }
    state.selected.add(idx);
  }

  renderGrid();
  log("tile_toggle", {idx, word: state.tiles[idx].word, selected: !wasSelected});
}

function selectedWords(){
  return Array.from(state.selected).map(i=>state.tiles[i].word);
}
function selectedCatIndices(){
  return Array.from(state.selected).map(i=>state.tiles[i].catIndex);
}

function validateSelection(){
  if(state.ended) return;

  if(state.selected.size !== 4){
    msgEl.innerHTML = `Il faut s√©lectionner <strong>exactement 4 mots</strong>.`;
    return;
  }

  const L = LEVELS[state.levelIndex];
  const words = selectedWords();
  const cats = selectedCatIndices();

  // Marquer ces mots "essay√©s" -> gris√©s (mais r√©utilisables)
  words.forEach(w=>state.triedWordSet.add(w));

  // V√©rifier si les 4 mots appartiennent √† une m√™me cat√©gorie
  const uniqueCats = new Set(cats);
  let correct = false;
  let solvedCatIndex = null;

  if(uniqueCats.size === 1){
    const ci = cats[0];
    const targetSet = new Set(L.cats[ci].words);
    const ok = words.every(w=>targetSet.has(w));
    if(ok){
      correct = true;
      solvedCatIndex = ci;
    }
  }

  state.validateCount++;

  if(correct){
    if(!state.foundCats.has(solvedCatIndex)){
      state.foundCats.add(solvedCatIndex);
      state.points += 1;
      pointsSpan.textContent = String(state.points);
    }
    msgEl.innerHTML = trainingEl.checked
      ? `‚úÖ Bonne cat√©gorie : <strong>${L.cats[solvedCatIndex].name}</strong>.`
      : `‚úÖ Correct.`;
    log("validate", {result:"correct", words, catIndex: solvedCatIndex, catName: L.cats[solvedCatIndex].name});

  }else{
    state.errorCount++;
    msgEl.innerHTML = trainingEl.checked
      ? `‚ùå Pas une cat√©gorie. Essaie autrement.`
      : `‚ùå Incorrect.`;
    log("validate", {result:"wrong", words});
  }

  // Mise √† jour UI
  attemptsSpan.textContent = String(state.validateCount);
  foundSpan.textContent = String(state.foundCats.size);
  failsSpan.textContent = String(state.consecutiveFails);

  // D√©s√©lectionner apr√®s validation (mais conserver le gris√©)
  state.selected.clear();

  renderGrid();
  renderCatList();

  // Fin de grille si 4 validations OU badge (4 cat√©gories trouv√©es)
  const badgeNow = (state.foundCats.size === 4);
  if(badgeNow || state.validateCount >= 4){
    endGrid(badgeNow);
  }
}

function endGrid(badgeNow){
  if(state.ended) return;
  state.ended = true;

  const elapsed = Date.now() - state.gridStartAt;
  timeSpan.textContent = fmtMs(elapsed);

  const L = LEVELS[state.levelIndex];

  if(badgeNow){
    state.badges += 1;
    state.consecutiveFails = 0;
    badgesSpan.textContent = String(state.badges);
    msgEl.innerHTML = `üèÖ Badge ! Les <strong>4 cat√©gories</strong> ont √©t√© trouv√©es. (Suivant automatique)`;
  }else{
    state.consecutiveFails += 1;
    msgEl.innerHTML = `Grille termin√©e. Cat√©gories trouv√©es : <strong>${state.foundCats.size}/4</strong>. (Suivant automatique)`;
  }
  failsSpan.textContent = String(state.consecutiveFails);

  log("level_end", {
    badge: badgeNow,
    found: state.foundCats.size,
    validateCount: state.validateCount,
    errors: state.errorCount,
    clicks: state.clickCount,
    initMs: state.firstClickAt ? (state.firstClickAt - state.gridStartAt) : null,
    totalMs: elapsed,
    categories: L.cats.map(c=>c.name)
  });

  // R√®gle 3 √©checs
  if(state.consecutiveFails >= 3){
    openModal();
    return;
  }

  // auto next
  setTimeout(()=> nextLevel(), 900);
}

function nextLevel(){
  closeModal();
  if(state.levelIndex < LEVELS.length-1){
    state.levelIndex++;
    buildLevel();
  }else{
    // fin
    state.levelIndex++;
    buildLevel();
  }
}

function tickTime(){
  if(!LEVELS[state.levelIndex]) return;
  if(!state.gridStartAt) return;
  const elapsed = Date.now() - state.gridStartAt;
  timeSpan.textContent = fmtMs(elapsed);
  requestAnimationFrame(tickTime);
}

function resetAll(){
  if(!confirm("R√©initialiser la session ? (les donn√©es en m√©moire seront perdues si non t√©l√©charg√©es)")) return;
  state = {
    sessionId: crypto.randomUUID(),
    startedAt: Date.now(),
    levelIndex: 0,
    points: 0,
    badges: 0,
    consecutiveFails: 0,
    gridStartAt: 0,
    firstClickAt: null,
    clickCount: 0,
    validateCount: 0,
    errorCount: 0,
    foundCats: new Set(),
    triedWordSet: new Set(),
    selected: new Set(),
    tiles: [],
    ended: false,
    logs: []
  };
  pointsSpan.textContent = "0";
  badgesSpan.textContent = "0";
  failsSpan.textContent = "0";
  log("session_reset");
  buildLevel();
}

function downloadCSV(){
  // CSV simple : logs d√©taill√©s (√©v√©nements)
  const rows = state.logs.slice();
  if(rows.length === 0){
    alert("Aucune donn√©e √† t√©l√©charger pour l‚Äôinstant.");
    return;
  }

  // En-t√™tes = union des cl√©s
  const keys = new Set();
  rows.forEach(r => Object.keys(r).forEach(k => keys.add(k)));
  const header = Array.from(keys);

  function esc(v){
    if(v === null || v === undefined) return "";
    if(Array.isArray(v)) v = JSON.stringify(v);
    if(typeof v === "object") v = JSON.stringify(v);
    const s = String(v);
    if(/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
    return s;
  }

  const csv = [
    header.join(","),
    ...rows.map(r => header.map(k => esc(r[k])).join(","))
  ].join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  const sid = (subjectId() || "sujet").replace(/[^a-zA-Z0-9_-]/g,"_");
  a.download = `similitudes_${sid}_${state.sessionId.slice(0,8)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(a.href);
}

btnValidate.addEventListener("click", validateSelection);
btnNext.addEventListener("click", ()=>{
  // Permet d‚Äôavancer m√™me si la grille n‚Äôest pas ‚Äútermin√©e‚Äù
  log("manual_next");
  nextLevel();
});
btnReset.addEventListener("click", resetAll);
btnDownload.addEventListener("click", downloadCSV);

trainingEl.addEventListener("change", ()=>{
  renderCatList();
  log("training_toggle", {training: trainingEl.checked});
});

// Modal: stop/continue
btnStop.addEventListener("click", ()=>{
  closeModal();
  log("stop_after_3fails");
  msgEl.innerHTML = `Arr√™t. Pense √† <strong>T√©l√©charger CSV</strong>.`;
  btnValidate.disabled = true;
  btnNext.disabled = true;
});
btnContinue.addEventListener("click", ()=>{
  closeModal();
  log("continue_after_3fails");
  state.consecutiveFails = 0;
  failsSpan.textContent = "0";
  setTimeout(()=> nextLevel(), 200);
});

// Init
log("session_start");
buildLevel();
</script>
</body>
</html>
