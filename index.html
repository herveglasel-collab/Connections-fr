<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Similitudes+ (6â€“7 ans) â€” CatÃ©gories</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#111a2e;
      --panel2:#0f172a;
      --text:#e9eefc;
      --muted:#a9b4d6;
      --accent:#7dd3fc;
      --good:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;
      --tile:#172340;
      --tile2:#1b2a4f;
      --sel:#2c467f;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 20% 10%, #1b2a4f 0%, var(--bg) 55%);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height:100dvh;
      padding: 16px;
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
    }
    header{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    h1{
      margin:0;
      font-size: 18px;
      letter-spacing:.2px;
    }
    .sub{
      color:var(--muted);
      font-size: 13px;
    }
    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 13px;
      color: var(--muted);
      box-shadow: var(--shadow);
      display:flex;
      gap:8px;
      align-items:center;
      user-select:none;
    }
    .pill b{color:var(--text); font-weight:700}
    .btn{
      border: 0;
      border-radius: 14px;
      padding: 12px 14px;
      background: linear-gradient(180deg, rgba(125,211,252,.25), rgba(125,211,252,.12));
      color: var(--text);
      font-weight: 700;
      cursor:pointer;
      box-shadow: var(--shadow);
      border: 1px solid rgba(125,211,252,.35);
      touch-action: manipulation;
      font-size: 14px;
    }
    .btn:active{transform: translateY(1px)}
    .btn.secondary{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      font-weight: 650;
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(251,113,133,.25), rgba(251,113,133,.12));
      border: 1px solid rgba(251,113,133,.35);
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-top: 12px;
    }
    .tile{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 14px 10px;
      text-align:center;
      font-size: clamp(14px, 2.2vw, 18px);
      font-weight: 800;
      letter-spacing:.2px;
      user-select:none;
      cursor:pointer;
      min-height: 64px;
      display:flex;
      align-items:center;
      justify-content:center;
      touch-action: manipulation;
    }
    .tile:hover{background: rgba(255,255,255,.07)}
    .tile.selected{
      background: linear-gradient(180deg, rgba(125,211,252,.28), rgba(125,211,252,.12));
      border-color: rgba(125,211,252,.55);
      box-shadow: 0 0 0 2px rgba(125,211,252,.18) inset;
    }
    .tile.locked{
      opacity:.52;
      pointer-events:none;
      filter:saturate(.8);
    }
    .tile.solved{
      background: linear-gradient(180deg, rgba(52,211,153,.22), rgba(52,211,153,.10));
      border-color: rgba(52,211,153,.45);
      opacity:1;
    }
    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
      align-items:center;
      justify-content:space-between;
    }
    .leftControls, .rightControls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .hint{
      color: var(--muted);
      font-size: 13px;
      line-height:1.35;
      margin-top: 8px;
    }
    .msg{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--text);
      font-size: 14px;
      min-height: 42px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .msg.good{border-color: rgba(52,211,153,.35); background: rgba(52,211,153,.10)}
    .msg.bad{border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.10)}
    .small{
      color: var(--muted);
      font-size: 12px;
    }
    .footerRow{
      margin-top: 14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
    }
    .tog{
      display:flex; gap:8px; align-items:center;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      padding: 10px 12px;
      border-radius: 14px;
      user-select:none;
    }
    input[type="checkbox"]{
      width: 18px; height: 18px;
      accent-color: #7dd3fc;
    }

    /* tablette / mobile */
    @media (max-width: 560px){
      body{padding: 12px}
      .grid{gap:8px}
      .tile{min-height: 58px; border-radius: 14px}
      .btn{flex:1}
      .controls{gap:8px}
      .leftControls, .rightControls{width:100%}
      .rightControls{justify-content:flex-end}
    }
  </style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="title">
      <h1>Similitudes+ â€” Niveau 6â€“7 ans</h1>
      <div class="sub">Trouve 4 groupes de 4 mots (catÃ©gories simples). Touch-friendly pour tablette.</div>
    </div>
    <div class="topbar">
      <div class="pill">Puzzle <b id="puzzleIndex">1</b>/<span id="puzzleTotal">?</span></div>
      <div class="pill">TrouvÃ©s <b id="solvedCount">0</b>/4</div>
      <div class="pill">Erreurs <b id="mistakes">0</b>/4</div>
      <div class="pill">Temps <b id="time">0:00</b></div>
    </div>
  </header>

  <div class="panel">
    <div class="hint">
      ðŸ‘‰ SÃ©lectionne <b>4 mots</b>, puis appuie sur <b>Valider</b>.  
      Quand un groupe est trouvÃ©, il reste en vert.  
      (Pour lâ€™Ã©valuation : tu peux exporter les rÃ©ponses en CSV/JSON.)
    </div>

    <div class="grid" id="grid"></div>

    <div class="controls">
      <div class="leftControls">
        <button class="btn secondary" id="clearBtn">Effacer sÃ©lection</button>
        <button class="btn" id="checkBtn">Valider (4 mots)</button>
      </div>
      <div class="rightControls">
        <button class="btn secondary" id="skipBtn">Passer</button>
        <button class="btn danger" id="restartBtn">Recommencer</button>
      </div>
    </div>

    <div class="msg" id="msg">
      <span>Choisis 4 mots qui vont ensemble.</span>
      <span class="small" id="msgSmall"></span>
    </div>

    <div class="footerRow">
      <div class="tog">
        <input type="checkbox" id="showCats" />
        <label for="showCats">Afficher la catÃ©gorie aprÃ¨s rÃ©ussite</label>
      </div>
      <div class="rightControls">
        <button class="btn secondary" id="exportCsvBtn">Exporter CSV</button>
        <button class="btn secondary" id="exportJsonBtn">Exporter JSON</button>
      </div>
    </div>

  </div>
</div>

<script>
/** =========================
 *  BANQUE Dâ€™ITEMS 6â€“7 ANS
 *  Chaque puzzle = 4 catÃ©gories x 4 mots
 *  On mÃ©lange l'ordre des puzzles + la position des mots
 *  ========================= */
const ITEM_BANK_6_7 = [
  {
    id: "6-7-A1",
    groups: [
      { cat: "Animaux de la ferme", words: ["VACHE","CHEVAL","MOUTON","POULE"] },
      { cat: "Fruits",             words: ["POMME","POIRE","BANANE","ORANGE"] },
      { cat: "VÃªtements",          words: ["PULL","PANTALON","CHAUSSETTE","MANTEAU"] },
      { cat: "Couleurs",           words: ["ROUGE","BLEU","VERT","JAUNE"] }
    ]
  },
  {
    id: "6-7-A2",
    groups: [
      { cat: "Moyens de transport", words: ["BUS","TRAIN","VOITURE","VELO"] },
      { cat: "Ã‰cole",              words: ["CRAYON","GOMME","CAHIER","REGLE"] },
      { cat: "Parties du corps",    words: ["MAIN","PIED","NEZ","OREILLE"] },
      { cat: "Boissons",           words: ["EAU","LAIT","JUS","THE"] }
    ]
  },
  {
    id: "6-7-A3",
    groups: [
      { cat: "Instruments (simples)", words: ["TAMBOUR","FLUTE","PIANO","GUITARE"] },
      { cat: "LÃ©gumes",               words: ["CAROTTE","TOMATE","SALADE","POIREAU"] },
      { cat: "Dans la salle de bain", words: ["SAVON","BROSSE","DENTIFRICE","SERVIETTE"] },
      { cat: "Formes",                words: ["ROND","CARRE","TRIANGLE","ETOILE"] }
    ]
  },
  {
    id: "6-7-A4",
    groups: [
      { cat: "Animaux qui nagent", words: ["POISSON","DAUPHIN","BALEINE","TORTUE"] },
      { cat: "Ã€ la maison",        words: ["TABLE","CHAISE","LIT","LAMPE"] },
      { cat: "GoÃ»ters",            words: ["BISCUIT","YAOURT","COMPOTE","CHOCOLAT"] },
      { cat: "MÃ©tÃ©o",              words: ["PLUIE","SOLEIL","VENT","NEIGE"] }
    ]
  },
  {
    id: "6-7-A5",
    groups: [
      { cat: "Animaux qui volent", words: ["OISEAU","PAPILLON","ABEILLE","CHAUVE-SOURIS"] },
      { cat: "Jeux",               words: ["PUZZLE","BALLON","CARTES","LEGOS"] },
      { cat: "Cuisine",            words: ["ASSIETTE","CUILLERE","VERRE","FOURCHETTE"] },
      { cat: "Jours de la semaine",words: ["LUNDI","MARDI","JEUDI","SAMEDI"] }
    ]
  },
  {
    id: "6-7-A6",
    groups: [
      { cat: "Animaux de la forÃªt", words: ["RENARD","LAPIN","CERF","ECUREUIL"] },
      { cat: "Desserts",            words: ["GLACE","GATEAU","CREPE","MOUSSE"] },
      { cat: "Objets qui s'ouvrent",words: ["PORTE","FENETRE","LIVRE","BOITE"] },
      { cat: "Contraires (concept simple)", words: ["GRAND","PETIT","CHAUD","FROID"] }
    ]
  }
];

/** =========================
 *  OUTILS
 *  ========================= */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
function nowISO(){ return new Date().toISOString(); }
function mmss(sec){
  const m = Math.floor(sec/60);
  const s = sec%60;
  return `${m}:${String(s).padStart(2,'0')}`;
}
function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/** =========================
 *  Ã‰TAT
 *  ========================= */
let sessionId = crypto?.randomUUID?.() || ("sess-" + Math.random().toString(16).slice(2));
let puzzles = [];
let puzzlePos = 0;

let tiles = [];           // {word, groupIndex, solved}
let selected = new Set(); // indexes of tiles
let solvedGroups = new Set();

let mistakes = 0;
let startTs = null;
let timerHandle = null;
let elapsedSec = 0;

let log = []; // donnÃ©es brutes (pour normage)
/*
  Chaque entrÃ©e:
  {
    sessionId, puzzleId, puzzleIndex, ts,
    action: "select"|"unselect"|"check"|"solve"|"mistake"|"skip"|"restart",
    selectionWords: [...],
    result: "ok"|"no",
    solvedGroupsCount, mistakes, elapsedSec
  }
*/

/** =========================
 *  DOM
 *  ========================= */
const gridEl = document.getElementById("grid");
const puzzleIndexEl = document.getElementById("puzzleIndex");
const puzzleTotalEl = document.getElementById("puzzleTotal");
const solvedCountEl = document.getElementById("solvedCount");
const mistakesEl = document.getElementById("mistakes");
const timeEl = document.getElementById("time");
const msgEl = document.getElementById("msg");
const msgSmallEl = document.getElementById("msgSmall");
const showCatsEl = document.getElementById("showCats");

document.getElementById("clearBtn").addEventListener("click", clearSelection);
document.getElementById("checkBtn").addEventListener("click", checkSelection);
document.getElementById("skipBtn").addEventListener("click", skipPuzzle);
document.getElementById("restartBtn").addEventListener("click", restartAll);
document.getElementById("exportCsvBtn").addEventListener("click", exportCSV);
document.getElementById("exportJsonBtn").addEventListener("click", exportJSON);

/** =========================
 *  INIT
 *  ========================= */
function init(){
  puzzles = shuffle(ITEM_BANK_6_7);
  puzzleTotalEl.textContent = puzzles.length;
  puzzlePos = 0;
  mistakes = 0;
  elapsedSec = 0;
  log = [];
  startTimer();
  loadPuzzle(puzzlePos);
  updateHUD();
  setMsg("Choisis 4 mots qui vont ensemble.", "");
}

function startTimer(){
  if(timerHandle) clearInterval(timerHandle);
  startTs = Date.now();
  timerHandle = setInterval(()=>{
    elapsedSec = Math.floor((Date.now()-startTs)/1000);
    timeEl.textContent = mmss(elapsedSec);
  }, 250);
}

function loadPuzzle(index){
  const puzzle = puzzles[index];
  puzzleIndexEl.textContent = (index+1);

  solvedGroups = new Set();
  selected = new Set();

  // construire 16 tuiles avec l'info du groupe
  const allTiles = [];
  puzzle.groups.forEach((g, gi)=>{
    g.words.forEach(w=>{
      allTiles.push({ word: w, groupIndex: gi, solved:false });
    });
  });

  tiles = shuffle(allTiles);
  renderGrid();

  // log
  pushLog("puzzle_load", { result:"ok" });
  updateHUD();
}

function renderGrid(){
  gridEl.innerHTML = "";
  tiles.forEach((t, idx)=>{
    const div = document.createElement("div");
    div.className = "tile";
    div.textContent = t.word;

    div.addEventListener("click", ()=>toggleTile(idx));
    div.addEventListener("touchstart", (e)=>{ /* amÃ©liore rÃ©activitÃ© tactile */ e.preventDefault(); toggleTile(idx); }, {passive:false});

    gridEl.appendChild(div);
  });
  refreshTileStyles();
}

function refreshTileStyles(){
  const children = Array.from(gridEl.children);
  children.forEach((el, idx)=>{
    const t = tiles[idx];
    el.classList.toggle("selected", selected.has(idx));
    el.classList.toggle("locked", t.solved && !el.classList.contains("solved"));
    el.classList.toggle("solved", t.solved);
  });
}

function toggleTile(idx){
  if(tiles[idx].solved) return;

  if(selected.has(idx)){
    selected.delete(idx);
    pushLog("unselect");
  }else{
    if(selected.size >= 4){
      nudge("SÃ©lectionne au maximum 4 mots.", "warn");
      return;
    }
    selected.add(idx);
    pushLog("select");
  }
  refreshTileStyles();
}

/** =========================
 *  GAMEPLAY
 *  ========================= */
function clearSelection(){
  selected.clear();
  pushLog("clear");
  refreshTileStyles();
  setMsg("SÃ©lection effacÃ©e.", "");
}

function checkSelection(){
  if(selected.size !== 4){
    nudge("Il faut choisir exactement 4 mots.", "warn");
    return;
  }

  const idxs = Array.from(selected);
  const picked = idxs.map(i=>tiles[i]);
  const groupIdx = picked[0].groupIndex;
  const ok = picked.every(t=>t.groupIndex === groupIdx);

  pushLog("check", { result: ok ? "ok":"no" });

  if(ok){
    // marquer ce groupe comme rÃ©solu
    idxs.forEach(i=> tiles[i].solved = true);
    solvedGroups.add(groupIdx);
    selected.clear();

    const catName = puzzles[puzzlePos].groups[groupIdx].cat;
    const catMsg = showCatsEl.checked ? `CatÃ©gorie : ${catName}` : "";
    setMsg("âœ… Bravo ! Groupe trouvÃ©.", catMsg, "good");
    pushLog("solve", { result:"ok", extra:{cat:catName} });

    // si fini
    if(solvedGroups.size === 4){
      setMsg("ðŸŽ‰ Puzzle terminÃ© ! On passe au suivant.", "", "good");
      setTimeout(nextPuzzle, 650);
    }
  }else{
    mistakes += 1;
    // petite vibration si dispo
    if(navigator.vibrate) navigator.vibrate(60);

    setMsg("âŒ Pas tout Ã  faitâ€¦ essaie encore.", `Erreurs restantes : ${Math.max(0, 4-mistakes)}`, "bad");
    pushLog("mistake", { result:"no" });
    // garder sÃ©lection, mais on peut aussi la vider
    // selected.clear();
  }

  if(mistakes >= 4){
    setMsg("â›” 4 erreurs. On passe au puzzle suivant.", "", "bad");
    setTimeout(nextPuzzle, 700);
  }

  updateHUD();
  refreshTileStyles();
}

function nextPuzzle(){
  if(puzzlePos < puzzles.length-1){
    puzzlePos += 1;
    loadPuzzle(puzzlePos);
  }else{
    finishSession();
  }
}

function skipPuzzle(){
  pushLog("skip", { result:"ok" });
  setMsg("Puzzle passÃ©.", "", "");
  nextPuzzle();
}

function restartAll(){
  pushLog("restart", { result:"ok" });
  sessionId = crypto?.randomUUID?.() || ("sess-" + Math.random().toString(16).slice(2));
  init();
}

function finishSession(){
  if(timerHandle) clearInterval(timerHandle);
  setMsg("âœ… TerminÃ© ! Tu peux exporter les donnÃ©es (CSV/JSON).", "", "good");
  pushLog("finish", { result:"ok" });
}

function updateHUD(){
  solvedCountEl.textContent = solvedGroups.size;
  mistakesEl.textContent = mistakes;
  timeEl.textContent = mmss(elapsedSec);
}

function setMsg(text, small="", kind=""){
  msgEl.classList.remove("good","bad");
  if(kind==="good") msgEl.classList.add("good");
  if(kind==="bad") msgEl.classList.add("bad");
  msgEl.firstElementChild.textContent = text;
  msgSmallEl.textContent = small;
}

function nudge(text, kind="warn"){
  if(kind==="warn"){
    setMsg("âš ï¸ " + text, "", "");
  }else{
    setMsg(text, "", "");
  }
}

/** =========================
 *  LOG / EXPORT
 *  ========================= */
function pushLog(action, opts={}){
  const puzzle = puzzles[puzzlePos];
  const selectionWords = Array.from(selected).map(i=>tiles[i]?.word).filter(Boolean);

  log.push({
    sessionId,
    ts: nowISO(),
    puzzleId: puzzle?.id || null,
    puzzleIndex: puzzlePos+1,
    action,
    selectionWords,
    result: opts.result || null,
    solvedGroupsCount: solvedGroups.size,
    mistakes,
    elapsedSec,
    extra: opts.extra || null
  });
}

function exportJSON(){
  const payload = {
    meta:{
      sessionId,
      createdAt: nowISO(),
      level: "6-7",
      puzzlesOrder: puzzles.map(p=>p.id)
    },
    log
  };
  downloadText(`similitudes_6-7_${sessionId}.json`, JSON.stringify(payload, null, 2));
}

function exportCSV(){
  // CSV simple (une ligne par log)
  const headers = [
    "sessionId","ts","level","puzzleId","puzzleIndex","action",
    "selectionWords","result","solvedGroupsCount","mistakes","elapsedSec","extra"
  ];
  const level = "6-7";
  const rows = log.map(r=>[
    r.sessionId,
    r.ts,
    level,
    r.puzzleId ?? "",
    r.puzzleIndex ?? "",
    r.action ?? "",
    (r.selectionWords || []).join("|"),
    r.result ?? "",
    r.solvedGroupsCount ?? 0,
    r.mistakes ?? 0,
    r.elapsedSec ?? 0,
    r.extra ? JSON.stringify(r.extra).replaceAll('"','""') : ""
  ]);

  const csv = [
    headers.join(","),
    ...rows.map(cols => cols.map(c=>{
      const s = String(c ?? "");
      // Ã©chapper si virgule/retour/quotes
      if(/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
      return s;
    }).join(","))
  ].join("\n");

  downloadText(`similitudes_6-7_${sessionId}.csv`, csv);
}

/** =========================
 *  START
 *  ========================= */
init();
</script>
</body>
</html>
